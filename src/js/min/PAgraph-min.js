!function($){function e(e,t){return void 0==t&&(t="value"),Math.max.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function t(e,t){return void 0==t&&(t="value"),Math.min.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function a(e,t){void 0==t&&(t="value");var a=0;for(var r in e)a+=e[r][t];return a}$.fn.PAgraph=function(a){function r(){return"#"+(16777215*Math.random()<<0).toString(16)}function n(a,r){var r=r||5,n=e(a),i=t(a),l=Math.ceil(.05*(n-i)),s=Math.ceil(.05*(n-i));i-=l,n+=s;for(var o=Math.round((n-i)/r),d=10*(o.toString().length-1),g=Math.round(2*o/d)/2*d,p=Math.floor(i/g)*g,h=[],c=0;r>=c;c++)h.push(p),p+=g;return h}function i(e){var t=[];for(var a in e)for(var r in e[a])t.push(e[a][r]);return t}function l(){s.debug&&console.debug(arguments)}var s=$.extend(!0,{mode:"history",filter:{mode:"daily",labels:["daily","weekly","monthly"]},config:{graph:[],grid:{x:{show:!0,color:"#E2E6E9",label:"#C1C1C1"},y:{show:!0,color:"#C6CED3",label:"#C1C1C1",format:null}}},lineInterpolation:"cardinal",preFetch:null},a),o=this;o.addClass("PAgraphContainer");var d={legend:null,tooltip:null,data:[],filters:null,svg:{element:null,grid:{group:null,x:{group:null,elements:[]},y:{group:null,elements:[]}},label:{x:{group:null,elements:[]},y:{group:null,spacing:[],elements:[]}},graph:{group:null,elements:[]}}},g={group:null,elements:{line:null,area:null,points:{coords:[],elements:[]}}},p={labels:{x:{height:30,marginTop:15},y:{width:60,marginLeft:10}},graphAnimationTime:600,animateGridTime:500,animateEasing:"cubic-in-out",graphLineInterpolation:s.lineInterpolation};d.legend=d3.selectAll(o.get()).append("div").classed("PAlegend",!0),d.tooltip=d3.selectAll(o.get()).append("div").classed("PAtooltip",!0),d.tooltip.append("span").text("3123"),d.tooltip.append("label").text("metric"),d.svg.element=d3.selectAll(o.get()).append("svg").classed("PAGraph",!0).classed("PAMode"+s.mode.capitalizeFirstLetter(),!0).attr("width",o.width()).attr("height",o.height()),d.svg.grid.group=d.svg.element.append("g").classed("PAGgrid",!0),d.svg.label.x.group=d.svg.element.append("g").classed("PAGlabelX",!0),d.svg.label.y.group=d.svg.element.append("g").classed("PAGlabelY",!0),d.svg.graph.group=d.svg.element.append("g").classed("PAGgraphs",!0);var h={history:{filter:"daily",computedData:[null,null],init:function(){l("MODE: history");var e=this;e.initLegend(),e.initCircles(),e.initFilters(),e.grid()},grid:function(){var e=this;e.initGridX(),e.initGridY()},initGridX:function(){var e=this,t=o.width(),a=o.height(),r=0,n=8;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width,t-=r);var i=Math.floor(t/(n-1));d.svg.grid.x.group=d.svg.grid.group.append("g").classed("PAGgridX",!0);for(var l=0;n>l;l++){var g=l*i+r,h=d.svg.grid.x.group.append("line").attr("x1",g).attr("y1",0).attr("x2",g).attr("y2",a).attr("stroke",s.config.grid.x.color);d.svg.grid.x.elements.push(h)}},initGridY:function(){var e=this,t=o.width(),a=o.height(),r=0;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width,t-=r);var n=6,i=Math.floor(a/n);d.svg.grid.y.group=d.svg.grid.group.append("g").classed("PAGgridY",!0);for(var l=0;n>l;l++){var g=d.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-l*i).attr("x2",o.width()).attr("y2",a-l*i).attr("stroke",s.config.grid.y.color);d.svg.grid.y.elements.push(g)}},initGraph:function(e,t,a,r){var n=this,i=$.Deferred();if(e&&d.svg.graph.elements[e])return i.resolve(e),i.promise();var l=o.width(),h=o.height(),c=0,u=$.extend(!0,{},g);u.group=d.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),d.svg.graph.elements.push(u);var m=d.svg.graph.elements.length-1;d.svg.graph.elements[m].group.attr("data-index",m);var t=t||"#"+((1<<24)*Math.random()|0).toString(16),a=a||"Graph "+m,r=r||null;s.config.graph.push({color:t,legend:a,format:r});var v=d.svg.grid.x.elements.length||8;d.svg.element.attr("data-points",v),0!=s.config.grid.x.label&&(h-=p.labels.x.height),0!=s.config.grid.y.label&&(c=p.labels.y.width);for(var f=Math.floor(l/(v-1)),y=[],x=0;v>x;x++){var b=x*f+c;y.push({x:b,y:h})}var A=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),C=A(y),P=d.svg.graph.elements[m].group.append("path").classed("PAGgraphLine",!0).attr("d",C).attr("stroke",s.config.graph[m].color).attr("stroke-width",1).attr("fill","none");d.svg.graph.elements[m].elements.line=P;var w=d.svg.graph.elements[m].group.append("path").classed("PAGgraphArea",!0).attr("d",C).attr("stroke-width",0).attr("fill",s.config.graph[m].color);d.svg.graph.elements[m].elements.area=w;var T=d.legend.append("p").attr("data-index",m);return T.append("span").style("background",s.config.graph[m].color),T.append("label").text(s.config.graph[m].legend),setTimeout(function(){i.resolve(m)},25*v),i.promise()},initLegend:function(){var e=this;o.find("div.PAlegend").addClass("PAhide").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},initFilters:function(){var e=this;d.filters=d3.selectAll(o.get()).insert("div",":first-child").classed("PAfilters",!0),d.filters.append("p").attr("data-mode","daily").text(s.filter.labels[0]),d.filters.append("p").attr("data-mode","weekly").text(s.filter.labels[1]),d.filters.append("p").attr("data-mode","monthly").text(s.filter.labels[2]),o.find("div.PAfilters").addClass("PAhide").on("click","p[data-mode]",function(){s.filter.mode=$(this).attr("data-mode"),e.applyFilter()})},setData:function(e,t){var a=this,r=$.Deferred(),t=t||0;if(d.data.length&&0==t&&d.data[0].length!=e.length&&(d.data=[],a.computedData=[]),e&&0!=e.length||r.reject("no"),0!=t&&d.data[0]&&d.data[0].length!=e.length)console.log("Compare metric has a different scale"),r.reject("no");else{d.data[t]=e,0==t&&(d.filters.classed("PAhide",!0),d.data[0].length>=28?(d.data[0].length>40&&"daily"==s.filter.mode&&(s.filter.mode="weekly"),d.filters.select('p[data-mode="daily"]').classed("PAhide",d.data[0].length>60),d.filters.select('p[data-mode="monthly"]').classed("PAhide",d.data[0].length<120),d.data[0].length<120&&"monthly"==s.filter.mode&&(s.filter.mode="daily"),d.filters.selectAll("p").classed("selected",!1),d.filters.select('p[data-mode="'+s.filter.mode+'"]').classed("selected",!0),setTimeout(function(){d.filters.classed("PAhide",!1)},p.animateGridTime)):(s.filter.mode="daily",d.filters.selectAll("p").classed("selected",!1),d.filters.select('p[data-mode="'+s.filter.mode+'"]').classed("selected",!0))),a.computedData[t]=a.applyFilterToData(e,s.filter.mode);var l=i(a.computedData);d.svg.grid.y.spacing=n(l),setTimeout(function(){r.resolve("ok")},10)}return r.promise()},draw:function(){var e=this;if(promises=[],promises.push(e.animateGridX(e.computedData[0])),promises.push(e.animateLabelY(e.computedData[0])),parseInt(d.svg.element.attr("data-points"))!=e.computedData[0].length)for(var t in d.svg.graph.elements)promises.push(e.flattenGraph(t));$.when.apply($,promises).done(function(){o.find("div.PAlegend").toggleClass("PAhide",e.computedData.length<2),d.svg.element.attr("data-points",e.computedData[0].length);for(var t in d.svg.graph.elements)e.computedData[t]?e.animateGraph(e.computedData[t],t):e.removeGraph(t)})},removeGraph:function(e){var t=this,a=$.Deferred();return $.when(t.flattenGraph(e)).done(function(){d.svg.graph.elements[e].group.remove(),d.svg.graph.elements.splice(e,1),o.find("div.PAlegend > p[data-index="+e+"]").remove(),d.data[e]=null,t.computedData[e]=null,a.resolve()}),a.promise()},applyFilter:function(){var e=this;d.filters.selectAll("p").classed("selected",!1),d.filters.select('p[data-mode="'+s.filter.mode+'"]').classed("selected",!0),e.computedData[0]=e.applyFilterToData(d.data[0],s.filter.mode),e.computedData[1]=e.applyFilterToData(d.data[1],s.filter.mode);var t=i(e.computedData);d.svg.grid.y.spacing=n(t),e.draw()},animateGraph:function(t,a){var r=this;if(!d.svg.graph.elements[a])return void console.log("structure not exist");var n=o.width(),i=o.height(),l=0;0!=s.config.grid.x.label&&(i-=p.labels.x.height),0!=s.config.grid.y.label&&(l=p.labels.y.width,n-=l);var g=Math.floor(n/(t.length-1)),h=Math.floor(i/6)/(d.svg.grid.y.spacing[1]-d.svg.grid.y.spacing[0]);d.svg.graph.elements[a].group.selectAll("circle").classed("PAhide","true"),setTimeout(function(){d.svg.graph.elements[a].group.selectAll("circle.PAhide").remove()},300);var c=[];for(var u in t){var m=u*g+l,v=parseInt(i-(t[u].value-d.svg.grid.y.spacing[0])*h);c.push({x:m,y:v})}d.svg.graph.elements[a].elements.points.coords=c;var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),y=f(c);pathCoordArea=y,pathCoordArea+="L"+e(c,"x")+","+i,pathCoordArea+="L"+l+","+i,pathCoordArea+="L"+l+","+c[0].y,d.svg.graph.elements[a].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing),d.svg.graph.elements[a].elements.line.transition().duration(p.graphAnimationTime).attr("d",y).ease(p.animateEasing).each("end",function(){r.animateCircles(t,a)})},flattenGraph:function(t){var a=this;console.log("flattenGraph",t);var r=$.Deferred(),n=o.width(),i=o.height(),l=0,g=parseInt(d.svg.element.attr("data-points"));0!=s.config.grid.x.label&&(i-=p.labels.x.height),0!=s.config.grid.y.label&&(l=p.labels.y.width,n-=l);for(var h=Math.floor(n/(g-1)),c=[],u=0;g>u;u++){var m=u*h+l;c.push({x:m,y:i})}var v=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),f=v(c);if(pathCoordArea=f,pathCoordArea+="L"+e(c,"x")+","+(i+1),pathCoordArea+="L"+l+","+(i+1),pathCoordArea+="L"+l+","+c[0].y,a.computedData[t]&&a.computedData[t].length){for(var y=Math.floor(n/(a.computedData[t].length-1)),c=[],u=0;u<a.computedData[t].length;u++){var m=u*y+l;c.push({x:m,y:i})}var v=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),x=v(c);pathCoordAreaNext=x,pathCoordAreaNext+="L"+e(c,"x")+","+(i+1),pathCoordAreaNext+="L"+l+","+(i+1),pathCoordAreaNext+="L"+l+","+c[0].y}return d.svg.graph.elements[t].group.selectAll("circle").transition().duration(p.graphAnimationTime).attr("cy",i).style("opacity",0).remove(),d.svg.graph.elements[t].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing).each("end",function(){d3.select(this).attr("d",pathCoordAreaNext)}),d.svg.graph.elements[t].elements.line.transition().duration(p.graphAnimationTime).attr("d",f).ease(p.animateEasing).each("end",function(){d3.select(this).attr("d",x),r.resolve()}),r.promise()},animateGridX:function(e){var t=this;console.log("animateGridX");var a=$.Deferred();t.animateLabelX(e);var r=o.width(),n=o.height(),i=0,l=e.length;0!=s.config.grid.x.label&&(n-=p.labels.x.height),0!=s.config.grid.y.label&&(i=p.labels.y.width,r-=i);var g=Math.floor(r/(l-1));if(l>d.svg.grid.x.elements.length)for(var h=l-d.svg.grid.x.elements.length,c=0;h>c;c++){var u=d.svg.grid.x.group.append("line").attr("x1",r+i+50).attr("y1",0).attr("x2",r+i+50).attr("y2",n).attr("stroke",s.config.grid.x.color).attr("data-count",c);d.svg.grid.x.elements.push(u)}for(var m in d.svg.grid.x.elements){var v=m*g+i;d.svg.grid.x.elements[m].transition().duration(p.animateGridTime).attr("x1",v).attr("x2",v).ease(p.animateEasing)}return setTimeout(function(){if(l<d.svg.grid.x.elements.length){for(var e=d.svg.grid.x.elements.length-l,t=0;e>t;t++){var r=t+l;d.svg.grid.x.elements[r].remove()}d.svg.grid.x.elements.splice(l,e)}a.resolve()},p.animateGridTime),a.promise()},animateLabelX:function(e){var t=this,a=$.Deferred(),r=o.width(),n=o.height(),i=0,l=e.length;s.config.grid.x.label&&(n-=p.labels.x.height),s.config.grid.y.label&&(i=p.labels.y.width,r-=i);var g=Math.floor(r/(e.length-1));if(d.svg.label.x.group.classed("PAhide",!0).selectAll("text").classed("show",!1),setTimeout(function(){for(var t in e){var r=t*g+i;if(d.svg.label.x.elements[t])d.svg.label.x.elements[t].attr("x",r).text(e[t].label);else{var l=d.svg.label.x.group.append("text").attr("x",r).attr("y",n+p.labels.x.marginTop).attr("text-anchor","middle").attr("fill",s.config.grid.x.label).text(e[t].label);d.svg.label.x.elements.push(l)}}a.resolve()},p.animateGridTime),l<d.svg.label.x.elements.length){for(var h=d.svg.grid.x.elements.length-l,c=0;h>c;c++){var u=c+l;d.svg.label.x.elements[u]&&d.svg.label.x.elements[u].remove()}d.svg.label.x.elements.splice(l,h)}return setTimeout(function(){t.hideThickLabels()},2*p.animateGridTime),a},hideThickLabels:function(){function e(e){var t=$("<span>").hide().appendTo(document.body);t.text(e.text()).css("font-family",e.css("font-family")).css("font-weight",e.css("font-weight")).css("font-size",e.css("font-size")).css("text-transform",e.css("text-transform"));var a=t.width();return t.remove(),a}for(var t=this,a=o.find("g.PAGlabelX"),r=1,n=1,i=a.find("text:eq("+n+")"),l={width:e(i),x:i.position().left},s=2,g=a.find("text:eq("+s+")").position().left;l.x+l.width+10>g;)r++,s++,g=a.find("text:eq("+s+")").position().left;d.svg.label.x.group.selectAll("text:nth-child("+r+"n+2)").classed("show",!0)},animateLabelY:function(e){var t=this;console.log("animateLabelY");var a=o.width(),r=o.height(),n=0,i=e.length;s.config.grid.x.label&&(r-=p.labels.x.height),s.config.grid.y.label&&(n=p.labels.y.width,a-=n);var i=6,l=Math.floor(r/i);d.svg.label.y.group.classed("PAhide",!0),setTimeout(function(){for(var e=0;i>e;e++)if(d.svg.label.y.elements[e])d.svg.label.y.elements[e].text(d.svg.grid.y.spacing[e]);else{var t=d.svg.label.y.group.append("text").attr("x",50).attr("y",r-e*l).attr("text-anchor","end").attr("fill",s.config.grid.y.label).html(d.svg.grid.y.spacing[e].format(s.config.grid.y.format));d.svg.label.y.elements.push(t)}},p.animateGridTime),setTimeout(function(){d.svg.label.y.group.classed("PAhide",!1)},2*p.animateGridTime)},animateCircles:function(e,t){var a=this;for(var r in d.svg.graph.elements[t].elements.points.coords){var n=d.svg.graph.elements[t].elements.points.coords[r],i=d.svg.graph.elements[t].group.append("circle").attr("cx",n.x).attr("cy",n.y).attr("r",0).attr("stroke-width",2).attr("stroke",s.config.graph[t].color).attr("fill","#fff").attr("data-value",e[r].value).attr("data-xStep",r).transition().delay(20*r).attr("r",4).ease(p.animateEasing);d.svg.graph.elements[t].elements.points.elements.push(i)}},setLegendLabel:function(e,t){var a=this;s.config.graph[t].legend=e,d.legend.select('p[data-index="'+t+'"] > label').text(e)},initCircles:function(){var e=this,t=null;o.on("mouseover","circle",function(){d.tooltip.style("display","block"),clearTimeout(t);var e=$(this).parent("g").attr("data-index"),a=$(this).attr("data-value");d.tooltip.style("color",s.config.graph[e].color).select("span").html(Number(a).format(s.config.graph[e].format)),d.tooltip.select("label").text(s.config.graph[e].legend);var r=d.tooltip.node().getBoundingClientRect(),n=$(d.tooltip[0][0]),i=n.width(),l=n.height(),o=$(this).attr("cx"),g=$(this).attr("cy"),p=g-l-20,h=o-parseInt(i/2)-10;n.css("top",p).css("left",h).addClass("show")}).on("mouseout","circle",function(){d.tooltip.classed("show",!1),t=setTimeout(function(){d.tooltip.style("display","none")},300)})},moveOnFront:function(e){var t=this,a=o.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)},applyFilterToData:function(e,t){function a(e){return e}function r(e){var t=[],a={label:"",value:0},r={},n=0;for(var i in e)i%7==0&&(r=$.extend(!0,{},a),r.label=e[i].label,t.push(r),n=t.length-1),t[n].value+=e[i].value;return t}function n(e){var t=[],a={label:"",value:0},r={},n=0;for(var i in e)i%30==0&&(r=$.extend(!0,{},a),r.label=e[i].label,t.push(r),n=t.length-1),t[n].value+=e[i].value;return t}var i=this,t=t||"daily",l=e;if(null==e)return null;switch(t){case"weekly":l=r(e);break;case"monthly":l=n(e);break;case"daily":l=a(e)}return l}},vertical_bar:{init:function(){l("MODE: weekday");var e=this;e.grid()},grid:function(){var e=this;e.initGridY(),e.initLegend(),e.initRects()},initGridY:function(){var e=this,t=o.width(),a=o.height(),r=0;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width,t-=r);var n=6,i=Math.floor(a/n);d.svg.grid.y.group=d.svg.grid.group.append("g").classed("PAGgridY",!0);for(var l=0;n>l;l++){var g=d.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-l*i).attr("x2",o.width()).attr("y2",a-l*i).attr("stroke",s.config.grid.y.color);d.svg.grid.y.elements.push(g)}},initGraph:function(e,t,a,r){var n=this,i=$.Deferred();if(e&&d.svg.graph.elements[e])return i.resolve(e),i.promise();var l=d.data[0]?d.data[0].length:5,h=o.width(),c=o.height(),u=0,m=$.extend(!0,{},g);m.group=d.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),m.elements.area=[],d.svg.graph.elements.push(m);var v=d.svg.graph.elements.length-1;d.svg.graph.elements[v].group.attr("data-index",v);var t=t||"#"+((1<<24)*Math.random()|0).toString(16),a=a||"Graph "+v,r=r||null;s.config.graph.push({color:t,legend:a,format:r}),0!=s.config.grid.x.label&&(c-=p.labels.x.height),0!=s.config.grid.y.label&&(u=p.labels.y.width,h-=u);for(var f=Math.floor(h/l),y=Math.floor(.7*f),x=Math.floor(.1*f),b=0;l>b;b++){var A=b*f+u+f/2-y/2+v*x,C=d.svg.graph.elements[v].group.append("rect").attr("x",A).attr("y",c-1).attr("width",y).attr("height",1).attr("rx",5).attr("ry",5).attr("fill",s.config.graph[v].color).style("opacity",0);d.svg.graph.elements[v].elements.area.push(C)}var P=d.legend.append("p").attr("data-index",v);return P.append("span").style("background",s.config.graph[v].color),P.append("label").text(s.config.graph[v].legend),0==v&&n.initLabelX(),setTimeout(function(){i.resolve(v)},25*l),i.promise()},initLabelX:function(){var e=this,t=5,a=o.width(),r=o.height(),n=0;0!=s.config.grid.x.label&&(r-=p.labels.x.height),0!=s.config.grid.y.label&&(n=p.labels.y.width,a-=n);for(var i=Math.floor(a/t),l=0;t>l;l++){var g=l*i+n+i/2,h=d.svg.label.x.group.append("text").attr("x",g).attr("y",r+p.labels.x.marginTop).attr("text-anchor","middle").attr("fill",s.config.grid.x.label).style("opacity",0);d.svg.label.x.elements.push(h)}},animateLabelY:function(){var e=this,t=e.computedData,a=o.width(),r=o.height(),n=0,i=t.length;s.config.grid.x.label&&(r-=p.labels.x.height),s.config.grid.y.label&&(n=p.labels.y.width,a-=n);var i=6,l=Math.floor(r/i);d.svg.label.y.group.classed("PAhide",!0),setTimeout(function(){for(var e=0;i>e;e++)if(d.svg.label.y.elements[e])d.svg.label.y.elements[e].text(d.svg.grid.y.spacing[e]);else{var t=d.svg.label.y.group.append("text").attr("x",50).attr("y",r-e*l).attr("text-anchor","end").attr("fill",s.config.grid.y.label).text(d.svg.grid.y.spacing[e]);d.svg.label.y.elements.push(t)}},p.animateGridTime),setTimeout(function(){d.svg.label.y.group.classed("PAhide",!1)},2*p.animateGridTime)},animateGridX:function(){var e=this,t=$.Deferred(),a=o.width(),r=o.height(),n=0;if(d.svg.graph.elements[0].elements.area.length!=d.data[0].length){0!=s.config.grid.x.label&&(r-=p.labels.x.height),0!=s.config.grid.y.label&&(n=p.labels.y.width,a-=n);var i=Math.floor(a/d.data[0].length),l=Math.floor(.7*i),g=Math.floor(.3*i);for(var h in d.data)for(var c in d.data[h]){var u=c*i+n+i/2-l/2+h*g;if(d.svg.graph.elements[h].elements.area[c])d.svg.graph.elements[h].elements.area[c].transition().duration(p.graphAnimationTime).attr("width",l).attr("x",u).style("opacity",1);else{var m=d.svg.graph.elements[h].group.append("rect").attr("x",u).attr("y",r-1).attr("width",l).attr("height",1).attr("rx",5).attr("ry",5).attr("fill",s.config.graph[h].color).style("opacity",0);m.transition().delay(p.graphAnimationTime/4).duration(p.graphAnimationTime).style("opacity",1),d.svg.graph.elements[h].elements.area.push(m)}if(0==h){var v=c*i+n+i/2;if(d.svg.label.x.elements[c])d.svg.label.x.elements[c].transition().duration(p.graphAnimationTime/4).style("opacity",0),d.svg.label.x.elements[c].transition().delay(p.graphAnimationTime/4).duration(p.graphAnimationTime).style("opacity",1).attr("x",v).text(d.data[0][c].label);else{var f=d.svg.label.x.group.append("text").attr("x",v).attr("y",r+p.labels.x.marginTop).attr("text-anchor","middle").attr("fill",s.config.grid.x.label).text(d.data[0][c].label).style("opacity",0);f.transition().delay(p.graphAnimationTime/4).duration(p.graphAnimationTime).style("opacity",1),d.svg.label.x.elements.push(f)}}}}else for(var c in d.data[0])d.svg.label.x.elements[c].text(d.data[0][c].label);return setTimeout(function(){t.resolve()},p.animateGridTime+100),t.promise()},setData:function(e,t){var a=this,r=$.Deferred(),t=t||0;return d.data.length&&0==t&&d.data[0].length!=e.length&&(d.data=[]),e&&0!=e.length||r.reject("no"),0!=t&&d.data[0]&&d.data[0].length!=e.length?(console.log("Compare metric has a different scale"),r.reject("no")):(d.data[t]=e,a.computedData=i(d.data),d.svg.grid.y.spacing=n(a.computedData),setTimeout(function(){r.resolve("ok")},10)),r.promise()},draw:function(){var e=this;promises=[],promises.push(e.animateLabelY()),promises.push(e.animateGridX()),$.when.apply($,promises).done(function(){o.find("div.PAlegend").toggleClass("PAhide",d.data.length<2);for(var t in d.svg.graph.elements)d.data[t]?e.animateGraph(d.data[t],t):e.removeGraph(t)})},animateGraph:function(e,t){var a=this,t=t||0,r=o.width(),n=o.height(),i=0;0!=s.config.grid.x.label&&(n-=p.labels.x.height),0!=s.config.grid.y.label&&(i=p.labels.y.width,r-=i);var l=Math.floor(r/(e.length-1)),g=Math.floor(n/6)/(d.svg.grid.y.spacing[1]-d.svg.grid.y.spacing[0]);for(var h in d.svg.graph.elements[t].elements.area){var c=parseInt(n-(e[h].value-d.svg.grid.y.spacing[0])*g);d.svg.graph.elements[t].elements.area[h].transition().duration(p.graphAnimationTime).attr("y",c).attr("height",n-c).attr("data-value",e[h].value).style("opacity",1).ease(p.animateEasing)}},flattenGraph:function(e){var t=this,a=$.Deferred();if(null==d.data[e])return a.reject(),a.promise();var r=o.height();0!=s.config.grid.x.label&&(r-=p.labels.x.height),d.data[e]=null,d.svg.graph.elements[0].group.classed("percentage",!1);for(var n in d.svg.graph.elements[e].elements.area)d.svg.graph.elements[e].elements.area[n].transition().duration(p.graphAnimationTime).attr("y",r-1).attr("height",1).ease(p.animateEasing);return setTimeout(function(){a.resolve()},p.graphAnimationTime+10),a.promise()},removeGraph:function(e){var t=this,a=$.Deferred();return $.when(t.flattenGraph(e)).done(function(){d.svg.graph.elements[e].group.remove(),d.svg.graph.elements.pop(),o.find("div.PAlegend > p[data-index="+e+"]").remove(),t.computedData=i(d.data),d.svg.grid.y.spacing=n(t.computedData),a.resolve()}),a.promise()},initLegend:function(){var e=this;o.find("div.PAlegend").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},setLegendLabel:function(e,t){var a=this;s.config.graph[t].legend=e,d.legend.select('p[data-index="'+t+'"] > label').text(e)},initRects:function(){var e=this,t=null;o.on("mouseover","g.PAGgraph > rect",function(){clearTimeout(t),d.tooltip.style("display","block");var e=$(this).parent("g").attr("data-index");d.tooltip.style("color",s.config.graph[e].color).select("span").text($(this).attr("data-value")),d.tooltip.select("label").text(s.config.graph[e].legend);var a=d.tooltip.node().getBoundingClientRect(),r=$(d.tooltip[0][0]),n=r.width(),i=r.height(),l=$(this).attr("x"),o=$(this).attr("y"),g=$(this).attr("width"),p=o-i-8,h=l-parseInt(n/2-g/2)-10;r.css("top",p).css("left",h).addClass("show")}).on("mouseout","g.PAGgraph > rect",function(){d.tooltip.classed("show",!1),t=setTimeout(function(){d.tooltip.style("display","none")},300)})},initCompareValues:function(){var e=this;if(null!=d.data[1]){var t=o.height();0!=s.config.grid.x.label&&(t-=p.labels.x.height);for(var a in d.data[0]){var r=d.data[0][a].value-d.data[1][a].value,n=Math.round(r/d.data[1][a].value*100);if(n=n>0?"+"+n+"%":0==n?"":n+"%",d.svg.graph.elements[0].elements.points.elements[a])d.svg.graph.elements[0].elements.points.elements[a].text(n);else{var i=d.svg.graph.elements[0].elements.area[a],l=parseInt(i.attr("x"))+parseInt(i.attr("width")/2),g=d.svg.graph.elements[0].group.append("text").attr("x",l).attr("y",t-p.labels.x.marginTop/2).attr("text-anchor","middle").attr("fill","#fff").text(n);d.svg.graph.elements[0].elements.points.elements.push(g)}}setTimeout(function(){d.svg.graph.elements[0].group.classed("percentage",!0)},p.graphAnimationTime)}},moveOnFront:function(e){var t=this,a=o.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)}}};return h[s.mode].init(),o.initGraph=function(e,t,a,r){return h[s.mode].initGraph(e,t,a,r)},o.setData=function(e,t){if("function"==typeof s.preFetch)var e=s.preFetch(e);return h[s.mode].setData(e,t)},o.removeGraph=function(e){return h[s.mode].removeGraph(e)},o.draw=function(){h[s.mode].draw()},o.setLegendLabel=function(e,t){h[s.mode].setLegendLabel(e,t)},o},$.fn.PAcounter=function(e){function t(e,t){e.each(function(){var e=$(this).text("0"),r=setTimeout(function(){e.html(a(1*e.attr("data-value"),e.attr("data-type")))},t+10);$({c:0}).animate({c:e.attr("data-value")},{duration:t,step:function(){var t=this.c;t==e.attr("data-value")&&clearInterval(r),e.html(a(t,e.attr("data-type")))}})})}function a(e,t){return e.format(void 0==t||"main"!=t?r.diff.format:r.main.format)}var r=$.extend(!0,{main:{value:0,format:{decimals:0}},diff:{value:null,format:{decimals:0}},icon:null},e),n=this;if(n.addClass("PAcounterContainer PAinactive"),n.find(".PAicon, .PAmain, .PAcompare").remove(),r.icon){var i=$("<span></span>").addClass("PAicon");n.append(i)}var l=$("<span></span>").attr("data-value",r.main.value).attr("data-type","main").text(r.main.value).addClass("PAmain PAcount");if(n.append(l),r.diff.value){var s=$("<span></span>").attr("data-value",r.diff.value).attr("data-type","diff").text(r.diff.value).addClass("PAcompare PAcount").toggleClass("PAnegative",r.diff.value<0).toggleClass("PAnull",0==r.diff.value);n.append(s)}if(r.icon){var o=$('<img src="'+r.icon+'" />');o.load(function(){i.append(o),t(n.find("span.PAcount"),1e3),n.removeClass("PAinactive")})}else t(n.find("span.PAcount"),1e3),n.removeClass("PAinactive");return n},$.fn.PAcustom=function(a){function r(e,t,a,r,n){n||e.html(Number(0).format(a)),setTimeout(function(){e.each(function(){var e=$(this),r=0;n&&(r=parseFloat(e.text())||0);var i=setTimeout(function(){e.html(Number(1*e.attr("data-value")).format(a))},t+10);$({c:r}).animate({c:e.attr("data-value")},{duration:t,step:function(){var t=this.c;t==e.attr("data-value")&&clearInterval(i),e.html(t.format(a))}})})},r||1)}var n=$.extend(!0,{mode:"horizontal_bar",data:[],main:{color:"#88b8c4",format:null},compare:{color:"#808f96",format:null}},a),i=this;i.addClass("PAcustomContainer");var l={horizontal_bar:{init:function(){var a=this;i.addClass("PACustomHBars");var r=d3.selectAll(i.get()).append("ul"),l=Math.abs(e(data)-t(data))/90;for(var s in n.data){var o=r.append("li");o.append("label").text(n.data[s].label),o.append("div").append("span").attr("data-perc",n.data[s].value/l).style("background",n.main.color),o.append("span").html(Number(n.data[s].value).format(n.main.format)).attr("data-value",n.data[s].value)}setTimeout(function(){a.animate()},100)},animate:function(){i.find("span[data-perc]").each(function(){$(this).width(parseInt($(this).attr("data-perc"))+"%")}),r(i.find("span[data-value]"),1e3,n.main.format,100)}},gender_distribution_v1:{female_icon:'<svg viewBox="0 0 58 58"><g fill="none"><rect fill="#808F96" x="0" y="0" width="58" height="58" rx="40"></rect><circle stroke="#FFFFFF" stroke-width="2" cx="29" cy="29" r="26.88"></circle><path d="M34.52496,40.79136 C34.49584,40.46992 34.47456,39.9536 34.45776,39.41824 C39.32416,38.91984 42.73792,37.7528 42.73792,36.39312 C42.72448,36.39088 42.7256,36.33712 42.7256,36.31472 C39.08784,33.03648 45.87952,9.73936 33.23584,10.212 C32.44176,9.54 31.05184,8.94304 29.05824,8.94304 C11.93232,10.23888 19.50464,32.23904 15.60256,36.392 C15.60032,36.39312 15.59696,36.39312 15.59472,36.39312 C15.59472,36.39536 15.59584,36.3976 15.59584,36.39984 C15.59584,36.40096 15.59472,36.40208 15.59472,36.40208 C15.59472,36.40208 15.59584,36.40208 15.59696,36.4032 C15.61264,37.73488 18.91104,38.88064 23.63632,39.39136 C23.62288,39.71616 23.59488,40.11824 23.53328,40.79136 C22.09744,44.652 14.62032,44.89392 10.4752,48.7344 C12.74096,50.71232 20.63584,56.02336 29.10528,56.02336 C37.57472,56.02336 44.60832,52.00368 47.4128,48.6224 C43.25872,44.89056 35.94624,44.61392 34.52496,40.79136 L34.52496,40.79136 Z" fill="#FFFFFF"></path></g></svg>',male_icon:'<svg viewBox="0 0 58 58"><g fill="none"><rect fill="#88b8c4" x="0" y="0" width="58" height="58" rx="40"></rect><circle stroke="#FFFFFF" stroke-width="2" cx="29" cy="29" r="26.88"></circle><path d="M34.52496,40.79136 C34.36144,38.98592 34.42416,37.72592 34.42416,36.07616 C35.24176,35.6472 36.70672,32.91216 36.95424,30.6016 C37.59712,30.54896 38.61072,29.92176 38.90752,27.44544 C39.06768,26.116 38.43152,25.36784 38.044,25.13264 C39.09008,21.98656 41.26288,12.25376 34.02544,11.248 C33.28064,9.93984 31.37328,9.27792 28.89472,9.27792 C18.97824,9.46048 17.78208,16.76624 19.956,25.13264 C19.5696,25.36784 18.93344,26.116 19.09248,27.44544 C19.3904,29.92176 20.40288,30.54896 21.04576,30.6016 C21.29216,32.91104 22.81536,35.6472 23.6352,36.07616 C23.6352,37.72592 23.6968,38.98592 23.53328,40.79136 C22.12096,44.58816 14.86784,44.88496 10.68352,48.54624 C15.05824,52.9512 22.14784,56.10176 29.62944,56.10176 C37.11104,56.10176 45.90528,50.19488 47.36912,48.5832 C43.21056,44.88832 35.94064,44.6016 34.52496,40.79136 L34.52496,40.79136 Z" fill="#FFFFFF"></path></g></svg>',donutContainer:null,donutForeground:null,init:function(){var e=this;i.addClass("PACustomGender1"),e.structure()},structure:function(){var e=this;e.donutContainer=d3.selectAll(i.get()).append("div").classed("PAdonut",!0);var t=d3.selectAll(i.get()).append("div").classed("PAdata",!0),a=t.append("p");a.html(e.male_icon).append("span").attr("data-value",0).html(Number(0).format(n.main.format));var r=t.append("p");r.html(e.female_icon).append("span").attr("data-value",0).html(Number(0).format(n.compare.format)),a.select("rect").style("fill",n.main.color),r.select("rect").style("fill",n.compare.color);var l=2*Math.PI,s=d3.svg.arc().innerRadius(65).outerRadius(65).startAngle(0),o=e.donutContainer.append("svg").attr("width",150).attr("height",150).append("g").attr("transform","translate(75,75)"),d=o.append("path").datum({endAngle:l}).style("stroke",n.main.color).style("stroke-width",15).attr("d",s);e.donutForeground=o.append("path").datum({endAngle:0}).style("stroke",n.compare.color).style("stroke-width",15).style("opacity",0).style("stroke-linejoin","round").attr("d",s)},animate:function(e){function t(e,t){e.attrTween("d",function(e){var a=d3.interpolate(e.endAngle,t);return function(t){return e.endAngle=a(t),s(e)}})}var a=this;i.find("div.PAdata p:eq(0) > span").attr("data-value",e[0].value),i.find("div.PAdata p:eq(1) > span").attr("data-value",e[1].value),r(i.find("span[data-value]"),1e3,n.main.format,100,!0);var l=2*Math.PI,s=d3.svg.arc().innerRadius(65).outerRadius(65).startAngle(0);a.donutForeground.style("opacity",1).transition().duration(1e3).call(t,e[1].value/100*l)}},age_distribution:{male_icon:'<svg viewBox="0 0 17 15"><path d="M14.0801524,14.4567109 C15.7050178,12.9316006 16.7199993,10.764331 16.7199993,8.35999966 C16.7199993,3.74289934 12.9771,0 8.35999966,0 C3.74289934,0 0,3.74289934 0,8.35999966 C0,10.7678635 1.01796621,12.9379685 2.64701267,14.4634289 C2.65246531,14.4552179 2.65791339,14.4471119 2.66335656,14.4391127 C3.96472984,13.3004111 6.22053641,13.2081028 6.65978473,12.0272528 C6.71064139,11.4657395 6.69148306,11.0738645 6.69148306,10.5607696 C6.43650307,10.4273579 5.96276976,9.57637961 5.88613642,8.8581163 C5.6861931,8.84174464 5.37129978,8.64667798 5.27864312,7.87651301 C5.22917979,7.46304136 5.42703311,7.2303547 5.54720811,7.15720471 C4.87109313,4.55515481 5.24311312,2.28297657 8.32725632,2.22619824 C9.09811796,2.22619824 9.6913296,2.43206323 9.92297126,2.83891655 C12.1739012,3.15171987 11.4981345,6.17873641 11.1727912,7.15720471 C11.2933145,7.2303547 11.4911679,7.46304136 11.4413562,7.87651301 C11.3490479,8.64667798 11.0338062,8.84174464 10.8338629,8.8581163 C10.7568812,9.57672794 10.3012612,10.4273579 10.0469779,10.5607696 C10.0469779,11.0738645 10.0274713,11.4657395 10.0783279,12.0272528 C10.5186212,13.2122828 12.7796528,13.3014561 14.0730144,14.4506077 C14.0753917,14.4526194 14.077771,14.4546538 14.0801524,14.4567109 Z"></path></svg>',
female_icon:'<svg viewBox="0 0 17 15"><path d="M14.0799816,14.4559844 C15.7049466,12.9309593 16.7199993,10.7637549 16.7199993,8.35948679 C16.7199993,3.74266972 12.9771,0 8.35999966,0 C3.74289934,0 0,3.74266972 0,8.35948679 C0,10.7645778 1.0157477,12.9324428 2.64168654,14.4575501 C3.93892102,13.3005812 6.21815684,13.2138769 6.65978473,12.026515 C6.67894306,11.8171795 6.68765139,11.6921355 6.69183139,11.5911251 C5.22221312,11.4322948 4.19637149,11.0759717 4.19323649,10.6583457 C5.40682978,9.36680495 3.05174821,2.52491332 8.37811299,2.1219164 C8.9981463,2.1219164 9.43042795,2.30756667 9.67739627,2.51655384 C13.6097311,2.36956619 11.4974379,9.61480306 12.6326561,10.658694 C12.6326561,11.0815447 11.5709362,11.4444857 10.0574279,11.5994845 C10.0626529,11.7659777 10.0692713,11.9265495 10.0783279,12.026515 C10.5196091,13.2132765 12.7868802,13.3010401 14.0799816,14.4559844 Z"></path></svg>',init:function(){var e=this;i.addClass("PACustomAgeDist");var t=d3.selectAll(i.get()).append("ul"),a=d3.selectAll(i.get()).append("div").classed("PAdetail hide",!0),l=a.append("p").classed("PAmale",!0).html(e.male_icon).style("color",n.main.color),s=l.append("label"),o=a.append("p").classed("PAfemale",!0).html(e.female_icon).style("color",n.compare.color),d=o.append("label"),g=0,p=100;for(var h in n.data){var c=n.data[h].value.m+n.data[h].value.f;g=c>g?c:g,p=p>c?c:p}var u=Math.abs(g-p)/50;for(var h in n.data){var m=t.append("li").attr("data-male",n.data[h].value.m).attr("data-female",n.data[h].value.f),v=n.data[h].value.m+n.data[h].value.f;if(v>0){m.append("label").text(n.data[h].label);var f=m.append("div").append("span").attr("data-perc",v/u).style("background",n.main.color),y=n.data[h].value.f/v;f.append("span").classed("PAhide",!0).attr("data-perc",100*y).style("background",n.compare.color),m.append("span").html(Number(v).format(n.main.format)).attr("data-value",v)}}i.on("click","li",function(){var e=$(this).find("span > span");i.find("li span > span").not(e).addClass("PAhide"),e.toggleClass("PAhide"),i.find("div.PAdetail").toggleClass("hide",0==i.find("li span > span:not(.PAhide)").length);var t=1*$(this).attr("data-male"),a=1*$(this).attr("data-female"),l=t/(t+a)*100;s.attr("data-value",l),d.attr("data-value",100-l),r(i.find("div.PAdetail label[data-value]"),1e3,n.main.format,null,!0)})},animate:function(e){var t=0,a=100;for(var l in e){var s=e[l].value.m+e[l].value.f;t=s>t?s:t,a=a>s?s:a}var o=Math.abs(t-a)/50;d3.selectAll(i.get()).selectAll("li:nth-child(n+"+parseInt(e.length+1)+")").transition().duration(300).style("opacity","0").delay(300).remove();var d=d3.selectAll(i.get()).selectAll("ul li");for(var l in e){var g=d3.select(d[0][l]),p=e[l].value.m+e[l].value.f;if(!g[0][0]){var g=d3.selectAll(i.get()).select("ul").append("li");if(p>0){g.append("label");var h=g.append("div").append("span").style("background",n.main.color),c=e[l].value.f/(e[l].value.m+e[l].value.f);h.append("span").classed("PAhide",!0).style("background",n.compare.color),g.append("span").html(Number(p).format(n.main.format))}}g.attr("data-male",e[l].value.m).attr("data-female",e[l].value.f),g.select("label").text(e[l].label);var c=e[l].value.f/p*100;g.select("div > span").attr("data-perc",p/o).select("span").classed("PAhide",!0).attr("data-perc",c),g.select("span[data-value]").attr("data-value",p),i.find("div.PAdetail").addClass("hide")}i.find("span[data-perc]").each(function(){$(this).width(parseInt($(this).attr("data-perc"))+"%")}),r(i.find("span[data-value]"),1e3,n.main.format,null,!0)}}};return l[n.mode].init(),i.animate=function(e){l[n.mode].animate(e)},i}}(jQuery),String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},Number.prototype.format=function(e){if(!e)return this.valueOf();var t="\\d(?=(\\d{3})+"+(e.decimals>0?"\\D":"$")+")",a=this.toFixed(Math.max(0,~~e.decimals)),r=(e.decimal?a.replace(".",e.decimal):a).replace(new RegExp(t,"g"),"$&"+(e.thousand||""));return(e.before||"")+r+(e.after||"")};