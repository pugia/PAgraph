!function($){$.fn.PAgraph=function(e){function t(){return"#"+(16777215*Math.random()<<0).toString(16)}function r(e){var t=5,a=n(e),r=l(e),s=Math.ceil(.05*(a-r));a+=s,r-=s;var o=Math.round((a-r)/t),g=10*(o.toString().length-1),d=Math.round(o/g)*g,h=Math.floor(r/d)*d,p=Math.ceil(a/d)*d,c=[];for(i=h;i<=p;i+=d)c.push(i);return c}function n(e,t){return void 0==t&&(t="value"),Math.max.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function l(e,t){return void 0==t&&(t="value"),Math.min.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function s(){o.debug&&console.debug(arguments)}var o=$.extend(!0,{mode:"history",config:{graph:[{color:"#88B8C4",legend:"metric"},{color:"#808E96",legend:"compare"}],grid:{x:{show:!0,color:"#E2E6E9",label:"#C1C1C1"},y:{show:!0,color:"#C6CED3",label:"#C1C1C1"}}}},e),g=this;g.addClass("PAgraphContainer");var d={legend:null,tooltip:null,svg:{element:null,grid:{group:null,x:{group:null,elements:[]},y:{group:null,elements:[]}},label:{x:{group:null,elements:[]},y:{group:null,spacing:[],elements:[]}},graph:{group:null,elements:[]}}},h={group:null,elements:{line:null,area:null,points:{coords:[],elements:[]}}},p={labels:{x:{height:30,marginTop:15},y:{width:60,marginLeft:10}},graphAnimationTime:600,animateGridTime:500,animateEasing:"cubic-in-out",graphLineInterpolation:"cardinal"};d.legend=d3.selectAll(g.get()).append("div").classed("PAlegend",!0),d.tooltip=d3.selectAll(g.get()).append("div").classed("PAtooltip",!0),d.tooltip.append("span").text("3123"),d.tooltip.append("label").text("metric"),d.svg.element=d3.selectAll(g.get()).append("svg").classed("PAGraph",!0).attr("width",g.width()).attr("height",g.height()),d.svg.grid.group=d.svg.element.append("g").classed("PAGgrid",!0),d.svg.label.x.group=d.svg.element.append("g").classed("PAGlabelX",!0),d.svg.label.y.group=d.svg.element.append("g").classed("PAGlabelY",!0),d.svg.graph.group=d.svg.element.append("g").classed("PAGgraphs",!0);var c={history:{mode:"daily",init:function(){s("MODE: history");var e=this;e.grid()},grid:function(){var e=this;e.initGridX(),e.initGridY(),e.initGraph(),e.initLegend(),e.initCircles()},initGridX:function(){var e=this,t=g.width(),a=g.height(),r=0,n=8;0!=o.config.grid.x.label&&(a-=p.labels.x.height),0!=o.config.grid.y.label&&(r=p.labels.y.width,t-=r);var l=Math.floor(t/(n-1));for(d.svg.grid.x.group=d.svg.grid.group.append("g").classed("PAGgridX",!0),i=0;i<n;i++){var s=i*l+r,h=d.svg.grid.x.group.append("line").attr("x1",s).attr("y1",0).attr("x2",s).attr("y2",a).attr("stroke",o.config.grid.x.color);d.svg.grid.x.elements.push(h)}},initGridY:function(){var e=this,t=g.width(),a=g.height(),r=0;0!=o.config.grid.x.label&&(a-=p.labels.x.height),0!=o.config.grid.y.label&&(r=p.labels.y.width,t-=r);var n=6,l=Math.floor(a/n);for(d.svg.grid.y.group=d.svg.grid.group.append("g").classed("PAGgridY",!0),i=0;i<n;i++){var s=d.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-i*l).attr("x2",g.width()).attr("y2",a-i*l).attr("stroke",o.config.grid.y.color);d.svg.grid.y.elements.push(s)}},initGraph:function(){var e=this,t=g.width(),a=g.height(),r=0,n=$.extend(!0,{},h);n.group=d.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),d.svg.graph.elements.push(n);var l=d.svg.graph.elements.length-1;d.svg.graph.elements[l].group.attr("data-index",l);var s=d.svg.grid.x.elements.length||8;0!=o.config.grid.x.label&&(a-=p.labels.x.height),0!=o.config.grid.y.label&&(r=p.labels.y.width);var c=Math.floor(t/(s-1)),v=[];for(i=0;i<s;i++){var u=i*c+r;v.push({x:u,y:a})}var m=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),f=m(v),x=d.svg.graph.elements[l].group.append("path").classed("PAGgraphLine",!0).attr("d",f).attr("stroke",o.config.graph[l].color).attr("stroke-width",1).attr("fill","none");d.svg.graph.elements[l].elements.line=x;var y=d.svg.graph.elements[l].group.append("path").classed("PAGgraphArea",!0).attr("d",f).attr("stroke-width",0).attr("fill",o.config.graph[l].color);d.svg.graph.elements[l].elements.area=y;var b=d.legend.append("p").attr("data-index",l);return b.append("span").style("background",o.config.graph[l].color),b.append("label").text(o.config.graph[l].legend),l},drawGraph:function(e,t){var a=this;0!=e.length&&(d.svg.grid.y.spacing=r(e),e.length!=d.svg.grid.x.elements.length?a.flattenGraph(e,t,function(){a.drawGraphAnimation(e,t)}):a.drawGraphAnimation(e,t))},drawGraphAnimation:function(e,t){var a=this;a.animateGridX(e),a.animateLabelY(e),setTimeout(function(){a.animateGraph(e,t)},p.animateGridTime)},animateGridX:function(e){var t=this;t.animateLabelX(e);var i=g.width(),r=g.height(),n=0,l=e.length;0!=o.config.grid.x.label&&(r-=p.labels.x.height),0!=o.config.grid.y.label&&(n=p.labels.y.width,i-=n);var s=Math.floor(i/(l-1));if(l>d.svg.grid.x.elements.length){var h=l-d.svg.grid.x.elements.length;for(a=0;a<h;a++){var c=d.svg.grid.x.group.append("line").attr("x1",i+n+50).attr("y1",0).attr("x2",i+n+50).attr("y2",r).attr("stroke",o.config.grid.x.color).attr("data-count",a);d.svg.grid.x.elements.push(c)}}for(var v in d.svg.grid.x.elements){var u=v*s+n;d.svg.grid.x.elements[v].transition().duration(p.animateGridTime).attr("x1",u).attr("x2",u).ease(p.animateEasing)}l<d.svg.grid.x.elements.length&&setTimeout(function(){var e=d.svg.grid.x.elements.length-l;for(a=0;a<e;a++){var t=a+l;d.svg.grid.x.elements[t].remove()}d.svg.grid.x.elements.splice(l,e)},p.animateGridTime)},animateLabelX:function(e){var t=this,i=g.width(),r=g.height(),n=0,l=e.length;o.config.grid.x.label&&(r-=p.labels.x.height),o.config.grid.y.label&&(n=p.labels.y.width,i-=n);var s=Math.floor(i/(e.length-1));if(d.svg.label.x.group.classed("hide",!0).selectAll("text").classed("show",!1),setTimeout(function(){for(var t in e){var a=t*s+n;if(d.svg.label.x.elements[t])d.svg.label.x.elements[t].attr("x",a).text(e[t].label);else{var i=d.svg.label.x.group.append("text").attr("x",a).attr("y",r+p.labels.x.marginTop).attr("text-anchor","middle").attr("fill",o.config.grid.x.label).text(e[t].label);d.svg.label.x.elements.push(i)}}},p.animateGridTime),l<d.svg.label.x.elements.length){var h=d.svg.grid.x.elements.length-l;for(a=0;a<h;a++){var c=a+l;d.svg.label.x.elements[c].remove()}d.svg.label.x.elements.splice(l,h)}setTimeout(function(){t.hideThickLabels()},2*p.animateGridTime)},hideThickLabels:function(){for(var e=1,t=1,a=d.svg.label.x.elements[t][0][0].getBBox(),i=2,r=d.svg.label.x.elements[i][0][0].getBBox();a.x+a.width+10>r.x;)e++,i++,r=d.svg.label.x.elements[i][0][0].getBBox();d.svg.label.x.group.selectAll("text:nth-child("+e+"n+2)").classed("show",!0)},animateLabelY:function(e){var t=this,a=g.width(),r=g.height(),n=0,l=e.length;o.config.grid.x.label&&(r-=p.labels.x.height),o.config.grid.y.label&&(n=p.labels.y.width,a-=n);var l=6,s=Math.floor(r/l);d.svg.label.y.group.classed("hide",!0),setTimeout(function(){for(i=0;i<l;i++)if(d.svg.label.y.elements[i])d.svg.label.y.elements[i].text(d.svg.grid.y.spacing[i]);else{var e=d.svg.label.y.group.append("text").attr("x",50).attr("y",r-i*s).attr("text-anchor","end").attr("fill",o.config.grid.y.label).text(d.svg.grid.y.spacing[i]);d.svg.label.y.elements.push(e)}},p.animateGridTime),setTimeout(function(){d.svg.label.y.group.classed("hide",!1)},2*p.animateGridTime)},animateGraph:function(e,t){var a=this,i=g.width(),r=g.height(),l=0;0!=o.config.grid.x.label&&(r-=p.labels.x.height),0!=o.config.grid.y.label&&(l=p.labels.y.width,i-=l);var s=Math.floor(i/(e.length-1)),h=Math.floor(r/6)/(d.svg.grid.y.spacing[1]-d.svg.grid.y.spacing[0]);d.svg.graph.elements[t].group.selectAll("circle").classed("hide","true"),setTimeout(function(){d.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var c=[];for(var v in e){var u=v*s+l,m=parseInt(r-(e[v].value-d.svg.grid.y.spacing[0])*h);c.push({x:u,y:m})}d.svg.graph.elements[t].elements.points.coords=c;var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),x=f(c);pathCoordArea=x,pathCoordArea+="L"+n(c,"x")+","+r,pathCoordArea+="L"+l+","+r,pathCoordArea+="L"+l+","+c[0].y,d.svg.graph.elements[t].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing),d.svg.graph.elements[t].elements.line.transition().duration(p.graphAnimationTime).attr("d",x).ease(p.animateEasing).each("end",function(){a.animateCircles(e,t)})},animateCircles:function(e,t){var a=this;for(var i in d.svg.graph.elements[t].elements.points.coords){var r=d.svg.graph.elements[t].elements.points.coords[i],n=d.svg.graph.elements[t].group.append("circle").attr("cx",r.x).attr("cy",r.y).attr("r",0).attr("stroke-width",2).attr("stroke",o.config.graph[t].color).attr("fill","#fff").attr("data-value",e[i].value).attr("data-xStep",i).transition().delay(20*i).attr("r",4).ease(p.animateEasing);d.svg.graph.elements[t].elements.points.elements.push(n)}},flattenGraph:function(e,t,a){var r=this,l=g.width(),s=g.height(),h=0;0!=o.config.grid.x.label&&(s-=p.labels.x.height),0!=o.config.grid.y.label&&(h=p.labels.y.width,l-=h);var c=Math.floor(l/(d.svg.grid.x.elements.length-1)),v=Math.floor(l/(e.length-1));d.svg.graph.elements[t].group.selectAll("circle").classed("hide",!0),setTimeout(function(){d.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var u=[];for(i=0;i<d.svg.grid.x.elements.length;i++){var m=i*c+h;u.push({x:m,y:s})}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),x=f(u);if(pathCoordArea=x,pathCoordArea+="L"+n(u,"x")+","+(s+1),pathCoordArea+="L"+h+","+(s+1),pathCoordArea+="L"+h+","+u[0].y,e.length){var u=[];for(i=0;i<e.length;i++){var m=i*v+h;u.push({x:m,y:s})}}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),y=f(u);pathCoordAreaNext=y,pathCoordAreaNext+="L"+n(u,"x")+","+(s+1),pathCoordAreaNext+="L"+h+","+(s+1),pathCoordAreaNext+="L"+h+","+u[0].y,d.svg.graph.elements[t].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing).each("end",function(){d.svg.graph.elements[t].elements.area.attr("d",pathCoordAreaNext)}),d.svg.graph.elements[t].elements.line.transition().duration(p.graphAnimationTime).attr("d",x).ease(p.animateEasing).each("end",function(){d.svg.graph.elements[t].elements.line.attr("d",y),"function"==typeof a&&a.call()})},addGraph:function(e){var t=this,a=t.initGraph();t.animateGraph(e,a)},removeGraph:function(){var e=this,t=d.svg.graph.elements.length-1;e.flattenGraph([],t,function(){d.svg.graph.elements[t].group.remove(),d.svg.graph.elements.pop(),g.find("div.PAlegend > p[data-index="+t+"]").remove()})},initLegend:function(){var e=this;g.find("div.PAlegend").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},initCircles:function(){var e=this;g.on("mouseover","circle",function(){d.tooltip.style("display","block");var e=$(this).parent("g").attr("data-index");d.tooltip.style("color",o.config.graph[e].color).select("span").text($(this).attr("data-value")),d.tooltip.select("label").text(o.config.graph[e].legend);var t=d.tooltip.node().getBoundingClientRect(),a=$(d.tooltip[0][0]),i=a.width(),r=a.height(),n=$(this).attr("cx"),l=$(this).attr("cy"),s=l-r-20,g=n-parseInt(i/2);a.css("top",s).css("left",g).addClass("show")}).on("mouseout","circle",function(){d.tooltip.classed("show",!1),setTimeout(function(){d.tooltip.style("display","none")},300)})},moveOnFront:function(e){var t=this,a=g.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)}}};return c[o.mode].init(),self.drawGraph=function(e,t){c[o.mode].drawGraph(e,t)},self.addGraph=function(e){c[o.mode].addGraph(e)},self.removeGraph=function(){c[o.mode].removeGraph()},self}}(jQuery);