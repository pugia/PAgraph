!function($){$.fn.PAgraph=function(e){function t(){return"#"+(16777215*Math.random()<<0).toString(16)}function r(e,t){var t=t||5,a=l(e),r=s(e),n=Math.ceil(.05*(a-r));a+=n,r-=n;var g=Math.round((a-r)/t),o=10*(g.toString().length-1),d=Math.round(g/o)*o,h=Math.floor(r/d)*d,p=Math.ceil(a/d)*d,c=[];for(i=h;i<=p;i+=d)c.push(i);return c}function n(e){var t=[];for(i in e)for(x in e[i])t.push(e[i][x]);return t}function l(e,t){return void 0==t&&(t="value"),Math.max.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function s(e,t){return void 0==t&&(t="value"),Math.min.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function g(){o.debug&&console.debug(arguments)}var o=$.extend(!0,{mode:"history",config:{graph:[{color:"#88B8C4",legend:"metric"},{color:"#808E96",legend:"compare"}],grid:{x:{show:!0,color:"#E2E6E9",label:"#C1C1C1"},y:{show:!0,color:"#C6CED3",label:"#C1C1C1"}}}},e),d=this;d.addClass("PAgraphContainer");var h={legend:null,tooltip:null,data:[null,null],svg:{element:null,grid:{group:null,x:{group:null,elements:[]},y:{group:null,elements:[]}},label:{x:{group:null,elements:[]},y:{group:null,spacing:[],elements:[]}},graph:{group:null,elements:[]}}},p={group:null,elements:{line:null,area:null,points:{coords:[],elements:[]}}},c={labels:{x:{height:30,marginTop:15},y:{width:60,marginLeft:10}},graphAnimationTime:600,animateGridTime:500,animateEasing:"cubic-in-out",graphLineInterpolation:"cardinal"};h.legend=d3.selectAll(d.get()).append("div").classed("PAlegend",!0),h.tooltip=d3.selectAll(d.get()).append("div").classed("PAtooltip",!0),h.tooltip.append("span").text("3123"),h.tooltip.append("label").text("metric"),h.svg.element=d3.selectAll(d.get()).append("svg").classed("PAGraph",!0).classed("PAMode"+o.mode.capitalizeFirstLetter(),!0).attr("width",d.width()).attr("height",d.height()),h.svg.grid.group=h.svg.element.append("g").classed("PAGgrid",!0),h.svg.label.x.group=h.svg.element.append("g").classed("PAGlabelX",!0),h.svg.label.y.group=h.svg.element.append("g").classed("PAGlabelY",!0),h.svg.graph.group=h.svg.element.append("g").classed("PAGgraphs",!0);var v={history:{mode:"daily",init:function(){g("MODE: history");var e=this;e.grid()},grid:function(){var e=this;e.initGridX(),e.initGridY(),e.initGraph(),e.initLegend(),e.initCircles()},initGridX:function(){var e=this,t=d.width(),a=d.height(),r=0,n=8;0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width,t-=r);var l=Math.floor(t/(n-1));for(h.svg.grid.x.group=h.svg.grid.group.append("g").classed("PAGgridX",!0),i=0;i<n;i++){var s=i*l+r,g=h.svg.grid.x.group.append("line").attr("x1",s).attr("y1",0).attr("x2",s).attr("y2",a).attr("stroke",o.config.grid.x.color);h.svg.grid.x.elements.push(g)}},initGridY:function(){var e=this,t=d.width(),a=d.height(),r=0;0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width,t-=r);var n=6,l=Math.floor(a/n);for(h.svg.grid.y.group=h.svg.grid.group.append("g").classed("PAGgridY",!0),i=0;i<n;i++){var s=h.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-i*l).attr("x2",d.width()).attr("y2",a-i*l).attr("stroke",o.config.grid.y.color);h.svg.grid.y.elements.push(s)}},initGraph:function(){var e=this,t=d.width(),a=d.height(),r=0,n=$.extend(!0,{},p);n.group=h.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),h.svg.graph.elements.push(n);var l=h.svg.graph.elements.length-1;h.svg.graph.elements[l].group.attr("data-index",l);var s=h.svg.grid.x.elements.length||8;0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width);var g=Math.floor(t/(s-1)),v=[];for(i=0;i<s;i++){var m=i*g+r;v.push({x:m,y:a})}var u=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(c.graphLineInterpolation),f=u(v),x=h.svg.graph.elements[l].group.append("path").classed("PAGgraphLine",!0).attr("d",f).attr("stroke",o.config.graph[l].color).attr("stroke-width",1).attr("fill","none");h.svg.graph.elements[l].elements.line=x;var y=h.svg.graph.elements[l].group.append("path").classed("PAGgraphArea",!0).attr("d",f).attr("stroke-width",0).attr("fill",o.config.graph[l].color);h.svg.graph.elements[l].elements.area=y;var b=h.legend.append("p").attr("data-index",l);return b.append("span").style("background",o.config.graph[l].color),b.append("label").text(o.config.graph[l].legend),l},mainGraph:function(e){var t=this,a=0;if(void 0==e)var e=h.data[0];if(0!=e.length){h.data[0]=e;var i=n(h.data);h.svg.grid.y.spacing=r(i),e.length!=h.svg.grid.x.elements.length?(h.data[1]&&t.removeCompareGraph(),h.svg.grid.y.spacing=r(e),t.flattenGraph(e,0,function(){t.drawGraphAnimation(h.data[0],0)})):(t.drawGraphAnimation(h.data[0],0),h.data[1]&&t.drawGraphAnimation(h.data[1],1))}},compareWith:function(e){var t=this,a=1==h.svg.graph.elements.length?t.initGraph():1;if(void 0==e)var e=h.data[a];if(0!=e.length){h.data[a]=e;var i=n(h.data);h.svg.grid.y.spacing=r(i),e.length!=h.svg.grid.x.elements.length?t.flattenGraph(e,a,function(){t.drawGraphAnimation(h.data[0],0),t.drawGraphAnimation(h.data[1],1)}):(t.drawGraphAnimation(h.data[0],0),t.drawGraphAnimation(h.data[1],1))}},drawGraphAnimation:function(e,t){var a=this;a.animateGridX(e),a.animateLabelY(e),setTimeout(function(){a.animateGraph(e,t)},c.animateGridTime)},animateGridX:function(e){var t=this;t.animateLabelX(e);var i=d.width(),r=d.height(),n=0,l=e.length;0!=o.config.grid.x.label&&(r-=c.labels.x.height),0!=o.config.grid.y.label&&(n=c.labels.y.width,i-=n);var s=Math.floor(i/(l-1));if(l>h.svg.grid.x.elements.length){var g=l-h.svg.grid.x.elements.length;for(a=0;a<g;a++){var p=h.svg.grid.x.group.append("line").attr("x1",i+n+50).attr("y1",0).attr("x2",i+n+50).attr("y2",r).attr("stroke",o.config.grid.x.color).attr("data-count",a);h.svg.grid.x.elements.push(p)}}for(var v in h.svg.grid.x.elements){var m=v*s+n;h.svg.grid.x.elements[v].transition().duration(c.animateGridTime).attr("x1",m).attr("x2",m).ease(c.animateEasing)}l<h.svg.grid.x.elements.length&&setTimeout(function(){var e=h.svg.grid.x.elements.length-l;for(a=0;a<e;a++){var t=a+l;h.svg.grid.x.elements[t].remove()}h.svg.grid.x.elements.splice(l,e)},c.animateGridTime)},animateLabelX:function(e){var t=this,i=d.width(),r=d.height(),n=0,l=e.length;o.config.grid.x.label&&(r-=c.labels.x.height),o.config.grid.y.label&&(n=c.labels.y.width,i-=n);var s=Math.floor(i/(e.length-1));if(h.svg.label.x.group.classed("hide",!0).selectAll("text").classed("show",!1),setTimeout(function(){for(var t in e){var a=t*s+n;if(h.svg.label.x.elements[t])h.svg.label.x.elements[t].attr("x",a).text(e[t].label);else{var i=h.svg.label.x.group.append("text").attr("x",a).attr("y",r+c.labels.x.marginTop).attr("text-anchor","middle").attr("fill",o.config.grid.x.label).text(e[t].label);h.svg.label.x.elements.push(i)}}},c.animateGridTime),l<h.svg.label.x.elements.length){var g=h.svg.grid.x.elements.length-l;for(a=0;a<g;a++){var p=a+l;h.svg.label.x.elements[p].remove()}h.svg.label.x.elements.splice(l,g)}setTimeout(function(){t.hideThickLabels()},2*c.animateGridTime)},hideThickLabels:function(){for(var e=1,t=1,a=h.svg.label.x.elements[t][0][0].getBBox(),i=2,r=h.svg.label.x.elements[i][0][0].getBBox();a.x+a.width+10>r.x;)e++,i++,r=h.svg.label.x.elements[i][0][0].getBBox();h.svg.label.x.group.selectAll("text:nth-child("+e+"n+2)").classed("show",!0)},animateLabelY:function(e){var t=this,a=d.width(),r=d.height(),n=0,l=e.length;o.config.grid.x.label&&(r-=c.labels.x.height),o.config.grid.y.label&&(n=c.labels.y.width,a-=n);var l=6,s=Math.floor(r/l);h.svg.label.y.group.classed("hide",!0),setTimeout(function(){for(i=0;i<l;i++)if(h.svg.label.y.elements[i])h.svg.label.y.elements[i].text(h.svg.grid.y.spacing[i]);else{var e=h.svg.label.y.group.append("text").attr("x",50).attr("y",r-i*s).attr("text-anchor","end").attr("fill",o.config.grid.y.label).text(h.svg.grid.y.spacing[i]);h.svg.label.y.elements.push(e)}},c.animateGridTime),setTimeout(function(){h.svg.label.y.group.classed("hide",!1)},2*c.animateGridTime)},animateGraph:function(e,t){var a=this,i=d.width(),r=d.height(),n=0;0!=o.config.grid.x.label&&(r-=c.labels.x.height),0!=o.config.grid.y.label&&(n=c.labels.y.width,i-=n);var s=Math.floor(i/(e.length-1)),g=Math.floor(r/6)/(h.svg.grid.y.spacing[1]-h.svg.grid.y.spacing[0]);h.svg.graph.elements[t].group.selectAll("circle").classed("hide","true"),setTimeout(function(){h.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var p=[];for(var v in e){var m=v*s+n,u=parseInt(r-(e[v].value-h.svg.grid.y.spacing[0])*g);p.push({x:m,y:u})}h.svg.graph.elements[t].elements.points.coords=p;var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(c.graphLineInterpolation),x=f(p);pathCoordArea=x,pathCoordArea+="L"+l(p,"x")+","+r,pathCoordArea+="L"+n+","+r,pathCoordArea+="L"+n+","+p[0].y,h.svg.graph.elements[t].elements.area.transition().duration(c.graphAnimationTime).attr("d",pathCoordArea).ease(c.animateEasing),h.svg.graph.elements[t].elements.line.transition().duration(c.graphAnimationTime).attr("d",x).ease(c.animateEasing).each("end",function(){a.animateCircles(e,t)})},animateCircles:function(e,t){var a=this;for(var i in h.svg.graph.elements[t].elements.points.coords){var r=h.svg.graph.elements[t].elements.points.coords[i],n=h.svg.graph.elements[t].group.append("circle").attr("cx",r.x).attr("cy",r.y).attr("r",0).attr("stroke-width",2).attr("stroke",o.config.graph[t].color).attr("fill","#fff").attr("data-value",e[i].value).attr("data-xStep",i).transition().delay(20*i).attr("r",4).ease(c.animateEasing);h.svg.graph.elements[t].elements.points.elements.push(n)}},flattenGraph:function(e,t,a){var r=this,n=d.width(),s=d.height(),g=0;0!=o.config.grid.x.label&&(s-=c.labels.x.height),0!=o.config.grid.y.label&&(g=c.labels.y.width,n-=g);var p=Math.floor(n/(h.svg.grid.x.elements.length-1)),v=Math.floor(n/(e.length-1));h.svg.graph.elements[t].group.selectAll("circle").classed("hide",!0),setTimeout(function(){h.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var m=[];for(i=0;i<h.svg.grid.x.elements.length;i++){var u=i*p+g;m.push({x:u,y:s})}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(c.graphLineInterpolation),x=f(m);if(pathCoordArea=x,pathCoordArea+="L"+l(m,"x")+","+(s+1),pathCoordArea+="L"+g+","+(s+1),pathCoordArea+="L"+g+","+m[0].y,e.length){var m=[];for(i=0;i<e.length;i++){var u=i*v+g;m.push({x:u,y:s})}}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(c.graphLineInterpolation),y=f(m);pathCoordAreaNext=y,pathCoordAreaNext+="L"+l(m,"x")+","+(s+1),pathCoordAreaNext+="L"+g+","+(s+1),pathCoordAreaNext+="L"+g+","+m[0].y,h.svg.graph.elements[t].elements.area.transition().duration(c.graphAnimationTime).attr("d",pathCoordArea).ease(c.animateEasing).each("end",function(){h.svg.graph.elements[t].elements.area.attr("d",pathCoordAreaNext)}),h.svg.graph.elements[t].elements.line.transition().duration(c.graphAnimationTime).attr("d",x).ease(c.animateEasing).each("end",function(){h.svg.graph.elements[t].elements.line.attr("d",y),"function"==typeof a&&a.call()})},removeCompareGraph:function(){var e=this;e.flattenGraph([],1,function(){h.svg.graph.elements[1].group.remove(),h.svg.graph.elements.pop(),d.find("div.PAlegend > p[data-index=1]").remove(),h.data[1]=null})},removeCompare:function(){var e=this;e.removeCompareGraph(),setTimeout(function(){e.mainGraph()},c.graphAnimationTime+2)},initLegend:function(){var e=this;d.find("div.PAlegend").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},initCircles:function(){var e=this,t=null;d.on("mouseover","circle",function(){h.tooltip.style("display","block"),clearTimeout(t);var e=$(this).parent("g").attr("data-index");h.tooltip.style("color",o.config.graph[e].color).select("span").text($(this).attr("data-value")),h.tooltip.select("label").text(o.config.graph[e].legend);var a=h.tooltip.node().getBoundingClientRect(),i=$(h.tooltip[0][0]),r=i.width(),n=i.height(),l=$(this).attr("cx"),s=$(this).attr("cy"),g=s-n-20,d=l-parseInt(r/2);i.css("top",g).css("left",d).addClass("show")}).on("mouseout","circle",function(){h.tooltip.classed("show",!1),t=setTimeout(function(){h.tooltip.style("display","none")},300)})},moveOnFront:function(e){var t=this,a=d.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)}},weekday:{init:function(){g("MODE: weekday");var e=this;e.grid()},grid:function(){var e=this;e.initGridY(),e.initGraph(),e.initLegend(),e.initRects()},initGridY:function(){var e=this,t=d.width(),a=d.height(),r=0;0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width,t-=r);var n=6,l=Math.floor(a/n);for(h.svg.grid.y.group=h.svg.grid.group.append("g").classed("PAGgridY",!0),i=0;i<n;i++){var s=h.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-i*l).attr("x2",d.width()).attr("y2",a-i*l).attr("stroke",o.config.grid.y.color);h.svg.grid.y.elements.push(s)}},initGraph:function(){var e=this,t=d.width(),a=d.height(),r=0,n=$.extend(!0,{},p);n.group=h.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),n.elements.area=[],h.svg.graph.elements.push(n);var l=h.svg.graph.elements.length-1;h.svg.graph.elements[l].group.attr("data-index",l),0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width,t-=r);var s=Math.floor(t/7),g=Math.floor(.7*s),v=Math.floor(.1*s);for(i=0;i<7;i++){var m=i*s+r+s/2-g/2+l*v,u=h.svg.graph.elements[l].group.append("rect").attr("x",m).attr("y",a-1).attr("width",g).attr("height",1).attr("rx",5).attr("ry",5).attr("fill",o.config.graph[l].color);h.svg.graph.elements[l].elements.area.push(u)}var f=h.legend.append("p").attr("data-index",l);return f.append("span").style("background",o.config.graph[l].color),f.append("label").text(o.config.graph[l].legend),l},initLabelX:function(){var e=this,t=d.width(),a=d.height(),r=0;0!=o.config.grid.x.label&&(a-=c.labels.x.height),0!=o.config.grid.y.label&&(r=c.labels.y.width,t-=r);var n=Math.floor(t/7);for(i=0;i<7;i++){var l=i*n+r+n/2,s=h.svg.label.x.group.append("text").attr("x",l).attr("y",a+c.labels.x.marginTop).attr("text-anchor","middle").attr("fill",o.config.grid.x.label).text(h.data[0][i].label);h.svg.label.x.elements.push(s)}},mainGraph:function(e){var t=this,a=0;if(void 0==e)var e=h.data[0];if(0!=e.length){h.data[0]=e,0==h.svg.label.x.elements.length&&t.initLabelX();var i=n(h.data);h.svg.grid.y.spacing=r(i),t.animateLabelY(i),setTimeout(function(){t.animateGraph(h.data[0],0),null!=h.data[1]&&t.animateGraph(h.data[1],1)},c.animateGridTime)}},compareWith:function(e){var t=this,a=1==h.svg.graph.elements.length?t.initGraph():1;if(void 0==e)var e=h.data[1];if(0!=e.length){h.data[1]=e;var i=n(h.data);h.svg.grid.y.spacing=r(i),t.animateLabelY(i),h.svg.graph.elements[0].group.classed("percentage",!1),t.animateGraph(h.data[0],0),t.animateGraph(h.data[1],1),setTimeout(function(){t.initCompareValues()},c.animateGridTime)}},animateLabelY:function(e){var t=this,a=d.width(),r=d.height(),n=0,l=e.length;o.config.grid.x.label&&(r-=c.labels.x.height),o.config.grid.y.label&&(n=c.labels.y.width,a-=n);var l=6,s=Math.floor(r/l);h.svg.label.y.group.classed("hide",!0),setTimeout(function(){for(i=0;i<l;i++)if(h.svg.label.y.elements[i])h.svg.label.y.elements[i].text(h.svg.grid.y.spacing[i]);else{var e=h.svg.label.y.group.append("text").attr("x",50).attr("y",r-i*s).attr("text-anchor","end").attr("fill",o.config.grid.y.label).text(h.svg.grid.y.spacing[i]);h.svg.label.y.elements.push(e)}},c.animateGridTime),setTimeout(function(){h.svg.label.y.group.classed("hide",!1)},2*c.animateGridTime)},animateGraph:function(e,t){var a=this,t=t||0,r=d.width(),n=d.height(),l=0;0!=o.config.grid.x.label&&(n-=c.labels.x.height),0!=o.config.grid.y.label&&(l=c.labels.y.width,r-=l);var s=Math.floor(r/(e.length-1)),g=Math.floor(n/6)/(h.svg.grid.y.spacing[1]-h.svg.grid.y.spacing[0]);for(i in h.svg.graph.elements[t].elements.area){var p=parseInt(n-(e[i].value-h.svg.grid.y.spacing[0])*g);h.svg.graph.elements[t].elements.area[i].transition().duration(c.graphAnimationTime).attr("y",p).attr("height",n-p).attr("data-value",e[i].value).ease(c.animateEasing)}},removeCompare:function(){var e=this,t=1,a=d.height();0!=o.config.grid.x.label&&(a-=c.labels.x.height),h.data[t]=null,e.mainGraph(),h.svg.graph.elements[0].group.classed("percentage",!1);for(i in h.svg.graph.elements[t].elements.area)h.svg.graph.elements[t].elements.area[i].transition().duration(c.graphAnimationTime).attr("y",a-1).attr("height",1).ease(c.animateEasing);setTimeout(function(){h.svg.graph.elements[t].group.remove(),h.svg.graph.elements.pop(),d.find("div.PAlegend > p[data-index="+t+"]").remove()},c.graphAnimationTime)},initLegend:function(){var e=this;d.find("div.PAlegend").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},initRects:function(){var e=this,t=null;d.on("mouseover","g.PAGgraph > rect",function(){clearTimeout(t),h.tooltip.style("display","block");var e=$(this).parent("g").attr("data-index");h.tooltip.style("color",o.config.graph[e].color).select("span").text($(this).attr("data-value")),h.tooltip.select("label").text(o.config.graph[e].legend);var a=h.tooltip.node().getBoundingClientRect(),i=$(h.tooltip[0][0]),r=i.width(),n=i.height(),l=$(this).attr("x"),s=$(this).attr("y"),g=$(this).attr("width"),d=s-n-20,p=l-parseInt(r/2-g/2);i.css("top",d).css("left",p).addClass("show")}).on("mouseout","g.PAGgraph > rect",function(){h.tooltip.classed("show",!1),t=setTimeout(function(){h.tooltip.style("display","none")},300)})},initCompareValues:function(){var e=this;if(null!=h.data[1]){var t=d.height();0!=o.config.grid.x.label&&(t-=c.labels.x.height);for(i in h.data[0]){var a=h.data[0][i].value-h.data[1][i].value,r=Math.round(a/h.data[1][i].value*100);if(r=r>0?"+"+r+"%":0==r?"":r+"%",h.svg.graph.elements[0].elements.points.elements[i])h.svg.graph.elements[0].elements.points.elements[i].text(r);else{var n=h.svg.graph.elements[0].elements.area[i],l=parseInt(n.attr("x"))+parseInt(n.attr("width")/2),s=h.svg.graph.elements[0].group.append("text").attr("x",l).attr("y",t-c.labels.x.marginTop/2).attr("text-anchor","middle").attr("fill","#fff").text(r);h.svg.graph.elements[0].elements.points.elements.push(s)}}setTimeout(function(){h.svg.graph.elements[0].group.classed("percentage",!0)},c.graphAnimationTime)}},moveOnFront:function(e){var t=this,a=d.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)}}};return v[o.mode].init(),self.drawGraph=function(e,t){v[o.mode].drawGraph(e,t)},self.mainGraph=function(e){v[o.mode].mainGraph(e)},self.compareWith=function(e){v[o.mode].compareWith(e)},self.removeCompare=function(){v[o.mode].removeCompare()},self}}(jQuery),String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)};