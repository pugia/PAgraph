!function($){$.fn.PAgraph=function(e){function t(e){var t=5,a=r(e),l=n(e),g=Math.ceil(.05*(a-l));a+=g,l-=g;var s=Math.round((a-l)/t),o=10*(s.toString().length-1),h=Math.round(s/o)*o,d=Math.floor(l/h)*h,p=Math.ceil(a/h)*h,v=[];for(i=d;i<=p;i+=h)v.push(i);return v}function r(e,t){return void 0==t&&(t="value"),Math.max.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function n(e,t){return void 0==t&&(t="value"),Math.min.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}var l=$.extend(!0,{mode:"history",config:{graph:[{color:"#88B8C4",legend:"metric"}],grid:{x:{show:!0,color:"#E2E6E9",label:"#C1C1C1"},y:{show:!0,color:"#C6CED3",label:"#C1C1C1"}}}},e),g=this,s={svg:{element:null,grid:{group:null,x:{group:null,elements:[]},y:{group:null,elements:[]}},label:{x:{group:null,elements:[]},y:{group:null,spacing:[],elements:[]}},graph:{group:null,elements:[{group:null,elements:{line:null,area:null,points:{coords:[],elements:[]}}}]}}},o={labels:{x:{height:30,marginTop:15},y:{width:60,marginLeft:10}},graphAnimationTime:600,animateGridTime:500,animateEasing:"cubic-in-out",graphLineInterpolation:"cardinal"};s.svg.element=d3.selectAll(g.get()).append("svg").classed("PAGraph",!0).attr("width",g.width()).attr("height",g.height()),s.svg.grid.group=s.svg.element.append("g").classed("PAGgrid",!0),s.svg.label.x.group=s.svg.element.append("g").classed("PAGlabelX",!0),s.svg.label.y.group=s.svg.element.append("g").classed("PAGlabelY",!0),s.svg.graph.group=s.svg.element.append("g").classed("PAGgraphs",!0),s.svg.graph.elements[0].group=s.svg.graph.group.append("g").classed("PAGgraph",!0).attr("data-index",0);var h={history:{mode:"daily",init:function(){var e=this;e.grid()},grid:function(){var e=this;e.initGridX(),e.initGridY(),e.initGraph()},initGridX:function(){var e=this,t=g.width(),a=g.height(),r=0,n=8;0!=l.config.grid.x.label&&(a-=o.labels.x.height),0!=l.config.grid.y.label&&(r=o.labels.y.width,t-=r);var h=Math.floor(t/(n-1));for(s.svg.grid.x.group=s.svg.grid.group.append("g").classed("PAGgridX",!0),i=0;i<n;i++){var d=i*h+r,p=s.svg.grid.x.group.append("line").attr("x1",d).attr("y1",0).attr("x2",d).attr("y2",a).attr("stroke",l.config.grid.x.color);s.svg.grid.x.elements.push(p)}},initGridY:function(){var e=this,t=g.width(),a=g.height(),r=0;0!=l.config.grid.x.label&&(a-=o.labels.x.height),0!=l.config.grid.y.label&&(r=o.labels.y.width,t-=r);var n=6,h=Math.floor(a/n);for(s.svg.grid.y.group=s.svg.grid.group.append("g").classed("PAGgridY",!0),i=0;i<n;i++){var d=s.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-i*h).attr("x2",g.width()).attr("y2",a-i*h).attr("stroke",l.config.grid.y.color);s.svg.grid.y.elements.push(d)}},initGraph:function(e){var t=this,e=e||0,a=g.width(),r=g.height(),n=0,h=8;0!=l.config.grid.x.label&&(r-=o.labels.x.height),0!=l.config.grid.y.label&&(n=o.labels.y.width);var d=Math.floor(a/(h-1)),p=[];for(i=0;i<h;i++){var v=i*d+n;p.push({x:v,y:r})}var c=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(o.graphLineInterpolation),m=c(p),u=s.svg.graph.elements[e].group.append("path").classed("PAGgraphLine",!0).attr("d",m).attr("stroke",l.config.graph[e].color).attr("stroke-width",1).attr("fill","none");s.svg.graph.elements[e].elements.line=u;var f=s.svg.graph.elements[e].group.append("path").classed("PAGgraphArea",!0).attr("d",m).attr("stroke-width",0).attr("fill",l.config.graph[e].color);s.svg.graph.elements[e].elements.area=f},drawGraph:function(e,a){var r=this;0!=e.length&&(s.svg.grid.y.spacing=t(e),e.length!=s.svg.grid.x.elements.length?r.flattenGraph(e,a,function(){r.drawGraphAnimation(e,a)}):r.drawGraphAnimation(e,a))},drawGraphAnimation:function(e,t){var a=this;a.animateGridX(e),a.animateLabelY(e),setTimeout(function(){a.animateGraph(e,t)},o.animateGridTime)},animateGridX:function(e){var t=this;t.animateLabelX(e);var r=g.width(),i=g.height(),n=0,h=e.length;0!=l.config.grid.x.label&&(i-=o.labels.x.height),0!=l.config.grid.y.label&&(n=o.labels.y.width,r-=n);var d=Math.floor(r/(h-1));if(h>s.svg.grid.x.elements.length){var p=h-s.svg.grid.x.elements.length;for(a=0;a<p;a++){var v=s.svg.grid.x.group.append("line").attr("x1",r+n+50).attr("y1",0).attr("x2",r+n+50).attr("y2",i).attr("stroke",l.config.grid.x.color).attr("data-count",a);s.svg.grid.x.elements.push(v)}}for(var c in s.svg.grid.x.elements){var m=c*d+n;s.svg.grid.x.elements[c].transition().duration(o.animateGridTime).attr("x1",m).attr("x2",m).ease(o.animateEasing)}h<s.svg.grid.x.elements.length&&setTimeout(function(){var e=s.svg.grid.x.elements.length-h;for(a=0;a<e;a++){var t=a+h;s.svg.grid.x.elements[t].remove()}s.svg.grid.x.elements.splice(h,e)},o.animateGridTime)},animateLabelX:function(e){var t=this,r=g.width(),i=g.height(),n=0,h=e.length;l.config.grid.x.label&&(i-=o.labels.x.height),l.config.grid.y.label&&(n=o.labels.y.width,r-=n);var d=Math.floor(r/(e.length-1));if(s.svg.label.x.group.classed("hide",!0).selectAll("text").classed("show",!1),setTimeout(function(){for(var t in e){var a=t*d+n;if(s.svg.label.x.elements[t])s.svg.label.x.elements[t].attr("x",a).text(e[t].label);else{var r=s.svg.label.x.group.append("text").attr("x",a).attr("y",i+o.labels.x.marginTop).attr("text-anchor","middle").attr("fill",l.config.grid.x.label).text(e[t].label);s.svg.label.x.elements.push(r)}}},o.animateGridTime),h<s.svg.label.x.elements.length){var p=s.svg.grid.x.elements.length-h;for(a=0;a<p;a++){var v=a+h;s.svg.label.x.elements[v].remove()}s.svg.label.x.elements.splice(h,p)}setTimeout(function(){t.hideThickLabels()},2*o.animateGridTime)},hideThickLabels:function(){for(var e=1,t=1,a=s.svg.label.x.elements[t][0][0].getBBox(),r=2,i=s.svg.label.x.elements[r][0][0].getBBox();a.x+a.width+10>i.x;)e++,r++,i=s.svg.label.x.elements[r][0][0].getBBox();s.svg.label.x.group.selectAll("text:nth-child("+e+"n+2)").classed("show",!0)},animateLabelY:function(e){var t=this,a=g.width(),r=g.height(),n=0,h=e.length;l.config.grid.x.label&&(r-=o.labels.x.height),l.config.grid.y.label&&(n=o.labels.y.width,a-=n);var h=6,d=Math.floor(r/h);s.svg.label.y.group.classed("hide",!0),setTimeout(function(){for(i=0;i<h;i++)if(s.svg.label.y.elements[i])s.svg.label.y.elements[i].text(s.svg.grid.y.spacing[i]);else{var e=s.svg.label.y.group.append("text").attr("x",50).attr("y",r-i*d).attr("text-anchor","end").attr("fill",l.config.grid.y.label).text(s.svg.grid.y.spacing[i]);s.svg.label.y.elements.push(e)}},o.animateGridTime),setTimeout(function(){s.svg.label.y.group.classed("hide",!1)},2*o.animateGridTime)},animateGraph:function(e,t){var a=this,i=g.width(),n=g.height(),h=0;0!=l.config.grid.x.label&&(n-=o.labels.x.height),0!=l.config.grid.y.label&&(h=o.labels.y.width,i-=h);var d=Math.floor(i/(e.length-1)),p=Math.floor(n/6)/(s.svg.grid.y.spacing[1]-s.svg.grid.y.spacing[0]);s.svg.graph.elements[t].group.selectAll("circle").classed("hide","true"),setTimeout(function(){s.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var v=[];for(var c in e){var m=c*d+h,u=parseInt(n-(e[c].value-s.svg.grid.y.spacing[0])*p);v.push({x:m,y:u})}s.svg.graph.elements[t].elements.points.coords=v;var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(o.graphLineInterpolation),x=f(v);pathCoordArea=x,pathCoordArea+="L"+r(v,"x")+","+n,pathCoordArea+="L"+h+","+n,pathCoordArea+="L"+h+","+v[0].y,s.svg.graph.elements[t].elements.area.transition().duration(o.graphAnimationTime).attr("d",pathCoordArea).ease(o.animateEasing),s.svg.graph.elements[t].elements.line.transition().duration(o.graphAnimationTime).attr("d",x).ease(o.animateEasing).each("end",function(){a.animateCircles(e,t)})},animateCircles:function(e,t){var a=this;for(var r in s.svg.graph.elements[t].elements.points.coords){var i=s.svg.graph.elements[t].elements.points.coords[r],n=s.svg.graph.elements[0].group.append("circle").attr("cx",i.x).attr("cy",i.y).attr("r",0).attr("stroke-width",2).attr("stroke",l.config.graph[t].color).attr("fill","#fff").transition().delay(20*r).attr("r",4).ease(o.animateEasing);s.svg.graph.elements[t].elements.points.elements.push(n)}},flattenGraph:function(e,t,a){var n=this,h=g.width(),d=g.height(),p=0;0!=l.config.grid.x.label&&(d-=o.labels.x.height),0!=l.config.grid.y.label&&(p=o.labels.y.width,h-=p);var v=Math.floor(h/(s.svg.grid.x.elements.length-1)),c=Math.floor(h/(e.length-1));s.svg.graph.elements[t].group.selectAll("circle").classed("hide",!0),setTimeout(function(){s.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var m=[];for(i=0;i<s.svg.grid.x.elements.length;i++){var u=i*v+p;m.push({x:u,y:d})}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(o.graphLineInterpolation),x=f(m);pathCoordArea=x,pathCoordArea+="L"+r(m,"x")+","+(d+1),pathCoordArea+="L"+p+","+(d+1),pathCoordArea+="L"+p+","+m[0].y;var m=[];for(i=0;i<e.length;i++){var u=i*c+p;m.push({x:u,y:d})}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(o.graphLineInterpolation),y=f(m);pathCoordAreaNext=y,pathCoordAreaNext+="L"+r(m,"x")+","+(d+1),pathCoordAreaNext+="L"+p+","+(d+1),pathCoordAreaNext+="L"+p+","+m[0].y,s.svg.graph.elements[t].elements.area.transition().duration(o.graphAnimationTime).attr("d",pathCoordArea).ease(o.animateEasing).each("end",function(){s.svg.graph.elements[t].elements.area.attr("d",pathCoordAreaNext)}),s.svg.graph.elements[t].elements.line.transition().duration(o.graphAnimationTime).attr("d",x).ease(o.animateEasing).each("end",function(){s.svg.graph.elements[t].elements.line.attr("d",y),"function"==typeof a&&a.call()})}}};return h[l.mode].init(),self.drawGraph=function(e,t){h[l.mode].drawGraph(e,t)},self}}(jQuery);