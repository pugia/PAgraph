!function($){$.fn.PAgraph=function(e){function t(){return"#"+(16777215*Math.random()<<0).toString(16)}function r(e){var t=5,a=n(e),r=l(e),g=Math.ceil(.05*(a-r));a+=g,r-=g;var s=Math.round((a-r)/t),o=10*(s.toString().length-1),d=Math.round(s/o)*o,h=Math.floor(r/d)*d,p=Math.ceil(a/d)*d,v=[];for(i=h;i<=p;i+=d)v.push(i);return v}function n(e,t){return void 0==t&&(t="value"),Math.max.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function l(e,t){return void 0==t&&(t="value"),Math.min.apply(null,Object.keys(e).map(function(a){return e[a][t]}))}function g(){s.debug&&console.debug(arguments)}var s=$.extend(!0,{mode:"history",config:{graph:[{color:"#88B8C4",legend:"metric"},{color:"#808E96",legend:"compare"}],grid:{x:{show:!0,color:"#E2E6E9",label:"#C1C1C1"},y:{show:!0,color:"#C6CED3",label:"#C1C1C1"}}}},e),o=this;o.addClass("PAgraphContainer");var d={legend:null,svg:{element:null,grid:{group:null,x:{group:null,elements:[]},y:{group:null,elements:[]}},label:{x:{group:null,elements:[]},y:{group:null,spacing:[],elements:[]}},graph:{group:null,elements:[]}}},h={group:null,elements:{line:null,area:null,points:{coords:[],elements:[]}}},p={labels:{x:{height:30,marginTop:15},y:{width:60,marginLeft:10}},graphAnimationTime:600,animateGridTime:500,animateEasing:"cubic-in-out",graphLineInterpolation:"cardinal"};d.legend=d3.selectAll(o.get()).append("div").classed("PAlegend",!0),d.svg.element=d3.selectAll(o.get()).append("svg").classed("PAGraph",!0).attr("width",o.width()).attr("height",o.height()),d.svg.grid.group=d.svg.element.append("g").classed("PAGgrid",!0),d.svg.label.x.group=d.svg.element.append("g").classed("PAGlabelX",!0),d.svg.label.y.group=d.svg.element.append("g").classed("PAGlabelY",!0),d.svg.graph.group=d.svg.element.append("g").classed("PAGgraphs",!0);var v={history:{mode:"daily",init:function(){g("MODE: history");var e=this;e.grid()},grid:function(){var e=this;e.initGridX(),e.initGridY(),e.initGraph(),e.initLegend()},initGridX:function(){var e=this,t=o.width(),a=o.height(),r=0,n=8;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width,t-=r);var l=Math.floor(t/(n-1));for(d.svg.grid.x.group=d.svg.grid.group.append("g").classed("PAGgridX",!0),i=0;i<n;i++){var g=i*l+r,h=d.svg.grid.x.group.append("line").attr("x1",g).attr("y1",0).attr("x2",g).attr("y2",a).attr("stroke",s.config.grid.x.color);d.svg.grid.x.elements.push(h)}},initGridY:function(){var e=this,t=o.width(),a=o.height(),r=0;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width,t-=r);var n=6,l=Math.floor(a/n);for(d.svg.grid.y.group=d.svg.grid.group.append("g").classed("PAGgridY",!0),i=0;i<n;i++){var g=d.svg.grid.y.group.append("line").attr("x1",r).attr("y1",a-i*l).attr("x2",o.width()).attr("y2",a-i*l).attr("stroke",s.config.grid.y.color);d.svg.grid.y.elements.push(g)}},initGraph:function(){var e=this,t=o.width(),a=o.height(),r=0,n=$.extend(!0,{},h);n.group=d.svg.graph.group.insert("g",":first-child").classed("PAGgraph",!0),d.svg.graph.elements.push(n);var l=d.svg.graph.elements.length-1;d.svg.graph.elements[l].group.attr("data-index",l);var g=d.svg.grid.x.elements.length||8;0!=s.config.grid.x.label&&(a-=p.labels.x.height),0!=s.config.grid.y.label&&(r=p.labels.y.width);var v=Math.floor(t/(g-1)),c=[];for(i=0;i<g;i++){var m=i*v+r;c.push({x:m,y:a})}var u=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),f=u(c),x=d.svg.graph.elements[l].group.append("path").classed("PAGgraphLine",!0).attr("d",f).attr("stroke",s.config.graph[l].color).attr("stroke-width",1).attr("fill","none");d.svg.graph.elements[l].elements.line=x;var b=d.svg.graph.elements[l].group.append("path").classed("PAGgraphArea",!0).attr("d",f).attr("stroke-width",0).attr("fill",s.config.graph[l].color);d.svg.graph.elements[l].elements.area=b;var y=d.legend.append("p").attr("data-index",l);return y.append("span").style("background",s.config.graph[l].color),y.append("label").text(s.config.graph[l].legend),l},drawGraph:function(e,t){var a=this;0!=e.length&&(d.svg.grid.y.spacing=r(e),e.length!=d.svg.grid.x.elements.length?a.flattenGraph(e,t,function(){a.drawGraphAnimation(e,t)}):a.drawGraphAnimation(e,t))},drawGraphAnimation:function(e,t){var a=this;a.animateGridX(e),a.animateLabelY(e),setTimeout(function(){a.animateGraph(e,t)},p.animateGridTime)},animateGridX:function(e){var t=this;t.animateLabelX(e);var r=o.width(),n=o.height(),i=0,l=e.length;0!=s.config.grid.x.label&&(n-=p.labels.x.height),0!=s.config.grid.y.label&&(i=p.labels.y.width,r-=i);var g=Math.floor(r/(l-1));if(l>d.svg.grid.x.elements.length){var h=l-d.svg.grid.x.elements.length;for(a=0;a<h;a++){var v=d.svg.grid.x.group.append("line").attr("x1",r+i+50).attr("y1",0).attr("x2",r+i+50).attr("y2",n).attr("stroke",s.config.grid.x.color).attr("data-count",a);d.svg.grid.x.elements.push(v)}}for(var c in d.svg.grid.x.elements){var m=c*g+i;d.svg.grid.x.elements[c].transition().duration(p.animateGridTime).attr("x1",m).attr("x2",m).ease(p.animateEasing)}l<d.svg.grid.x.elements.length&&setTimeout(function(){var e=d.svg.grid.x.elements.length-l;for(a=0;a<e;a++){var t=a+l;d.svg.grid.x.elements[t].remove()}d.svg.grid.x.elements.splice(l,e)},p.animateGridTime)},animateLabelX:function(e){var t=this,r=o.width(),n=o.height(),i=0,l=e.length;s.config.grid.x.label&&(n-=p.labels.x.height),s.config.grid.y.label&&(i=p.labels.y.width,r-=i);var g=Math.floor(r/(e.length-1));if(d.svg.label.x.group.classed("hide",!0).selectAll("text").classed("show",!1),setTimeout(function(){for(var t in e){var a=t*g+i;if(d.svg.label.x.elements[t])d.svg.label.x.elements[t].attr("x",a).text(e[t].label);else{var r=d.svg.label.x.group.append("text").attr("x",a).attr("y",n+p.labels.x.marginTop).attr("text-anchor","middle").attr("fill",s.config.grid.x.label).text(e[t].label);d.svg.label.x.elements.push(r)}}},p.animateGridTime),l<d.svg.label.x.elements.length){var h=d.svg.grid.x.elements.length-l;for(a=0;a<h;a++){var v=a+l;d.svg.label.x.elements[v].remove()}d.svg.label.x.elements.splice(l,h)}setTimeout(function(){t.hideThickLabels()},2*p.animateGridTime)},hideThickLabels:function(){for(var e=1,t=1,a=d.svg.label.x.elements[t][0][0].getBBox(),r=2,n=d.svg.label.x.elements[r][0][0].getBBox();a.x+a.width+10>n.x;)e++,r++,n=d.svg.label.x.elements[r][0][0].getBBox();d.svg.label.x.group.selectAll("text:nth-child("+e+"n+2)").classed("show",!0)},animateLabelY:function(e){var t=this,a=o.width(),r=o.height(),n=0,l=e.length;s.config.grid.x.label&&(r-=p.labels.x.height),s.config.grid.y.label&&(n=p.labels.y.width,a-=n);var l=6,g=Math.floor(r/l);d.svg.label.y.group.classed("hide",!0),setTimeout(function(){for(i=0;i<l;i++)if(d.svg.label.y.elements[i])d.svg.label.y.elements[i].text(d.svg.grid.y.spacing[i]);else{var e=d.svg.label.y.group.append("text").attr("x",50).attr("y",r-i*g).attr("text-anchor","end").attr("fill",s.config.grid.y.label).text(d.svg.grid.y.spacing[i]);d.svg.label.y.elements.push(e)}},p.animateGridTime),setTimeout(function(){d.svg.label.y.group.classed("hide",!1)},2*p.animateGridTime)},animateGraph:function(e,t){var a=this,r=o.width(),i=o.height(),l=0;0!=s.config.grid.x.label&&(i-=p.labels.x.height),0!=s.config.grid.y.label&&(l=p.labels.y.width,r-=l);var g=Math.floor(r/(e.length-1)),h=Math.floor(i/6)/(d.svg.grid.y.spacing[1]-d.svg.grid.y.spacing[0]);d.svg.graph.elements[t].group.selectAll("circle").classed("hide","true"),setTimeout(function(){d.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var v=[];for(var c in e){var m=c*g+l,u=parseInt(i-(e[c].value-d.svg.grid.y.spacing[0])*h);v.push({x:m,y:u})}d.svg.graph.elements[t].elements.points.coords=v;var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),x=f(v);pathCoordArea=x,pathCoordArea+="L"+n(v,"x")+","+i,pathCoordArea+="L"+l+","+i,pathCoordArea+="L"+l+","+v[0].y,d.svg.graph.elements[t].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing),d.svg.graph.elements[t].elements.line.transition().duration(p.graphAnimationTime).attr("d",x).ease(p.animateEasing).each("end",function(){a.animateCircles(e,t)})},animateCircles:function(e,t){var a=this;for(var r in d.svg.graph.elements[t].elements.points.coords){var n=d.svg.graph.elements[t].elements.points.coords[r],i=d.svg.graph.elements[t].group.append("circle").attr("cx",n.x).attr("cy",n.y).attr("r",0).attr("stroke-width",2).attr("stroke",s.config.graph[t].color).attr("fill","#fff").attr("data-value",e[r].value).attr("data-xStep",r).transition().delay(20*r).attr("r",4).ease(p.animateEasing);d.svg.graph.elements[t].elements.points.elements.push(i)}},flattenGraph:function(e,t,a){var r=this,l=o.width(),g=o.height(),h=0;0!=s.config.grid.x.label&&(g-=p.labels.x.height),0!=s.config.grid.y.label&&(h=p.labels.y.width,l-=h);var v=Math.floor(l/(d.svg.grid.x.elements.length-1)),c=Math.floor(l/(e.length-1));d.svg.graph.elements[t].group.selectAll("circle").classed("hide",!0),setTimeout(function(){d.svg.graph.elements[t].group.selectAll("circle.hide").remove()},300);var m=[];for(i=0;i<d.svg.grid.x.elements.length;i++){var u=i*v+h;m.push({x:u,y:g})}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),x=f(m);if(pathCoordArea=x,pathCoordArea+="L"+n(m,"x")+","+(g+1),pathCoordArea+="L"+h+","+(g+1),pathCoordArea+="L"+h+","+m[0].y,e.length){var m=[];for(i=0;i<e.length;i++){var u=i*c+h;m.push({x:u,y:g})}}var f=d3.svg.line().x(function(e){return e.x}).y(function(e){return e.y}).interpolate(p.graphLineInterpolation),b=f(m);pathCoordAreaNext=b,pathCoordAreaNext+="L"+n(m,"x")+","+(g+1),pathCoordAreaNext+="L"+h+","+(g+1),pathCoordAreaNext+="L"+h+","+m[0].y,d.svg.graph.elements[t].elements.area.transition().duration(p.graphAnimationTime).attr("d",pathCoordArea).ease(p.animateEasing).each("end",function(){d.svg.graph.elements[t].elements.area.attr("d",pathCoordAreaNext)}),d.svg.graph.elements[t].elements.line.transition().duration(p.graphAnimationTime).attr("d",x).ease(p.animateEasing).each("end",function(){d.svg.graph.elements[t].elements.line.attr("d",b),"function"==typeof a&&a.call()})},addGraph:function(e){var t=this,a=t.initGraph();t.animateGraph(e,a)},removeGraph:function(){var e=this,t=d.svg.graph.elements.length-1;e.flattenGraph([],t,function(){d.svg.graph.elements[t].group.remove(),d.svg.graph.elements.pop(),o.find("div.PAlegend > p[data-index="+t+"]").remove()})},initLegend:function(){var e=this;o.find("div.PAlegend").on("click","p[data-index]",function(){var t=parseInt($(this).attr("data-index"));e.moveOnFront(t)})},moveOnFront:function(e){var t=this,a=o.find("g.PAGgraphs");a.find("g.PAGgraph[data-index="+e+"]").appendTo(a)}}};return v[s.mode].init(),self.drawGraph=function(e,t){v[s.mode].drawGraph(e,t)},self.addGraph=function(e){v[s.mode].addGraph(e)},self.removeGraph=function(){v[s.mode].removeGraph()},self}}(jQuery);